<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
    










    







<script defer language="javascript" type="text/javascript" src="/js/bundle.min.60856f0f2ed73fb3cd2820ee548c4698ffbc4d743736e852c0e27ce4f52dfd9c.js"></script>






    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <link rel="icon" href=/favicon.png>

    
    





  





  
  
  

<meta property="og:url" content="https://randomgeekery.org/post/2010/10/ruby-and-the-hyg-star-catalog/">
<meta property="og:title" content="Ruby and the HYG Star Catalog">
<meta name="twitter:title" content="Ruby and the HYG Star Catalog">


  <meta name="twitter:site" content="@brianwisti">



  
    <meta name="twitter:description" content="One of my big projects over the last year has been a Parrot Babysteps tutorial. One of the more interesting tasks in that tutorial was reading a CSV file in Parrot. I used the HYG Star Catalog as a sample CSV file that was large enough to present some interesting data. This was fun in Parrot, but obviously I thought quite a bit about how I would tackle the problem in a higher level language such as Ruby. Today seems like a good day to find out.">
    <meta property="og:description" content="One of my big projects over the last year has been a Parrot Babysteps tutorial. One of the more interesting tasks in that tutorial was reading a CSV file in Parrot. I used the HYG Star Catalog as a sample CSV file that was large enough to present some interesting data. This was fun in Parrot, but obviously I thought quite a bit about how I would tackle the problem in a higher level language such as Ruby. Today seems like a good day to find out.">
  



<title itemprop="name">Ruby and the HYG Star Catalog - Random Geekery</title>
<meta property="og:title" content=Ruby&#32;and&#32;the&#32;HYG&#32;Star&#32;Catalog&#32;-&#32;Random&#32;Geekery />
<meta name="twitter:title" content=Ruby&#32;and&#32;the&#32;HYG&#32;Star&#32;Catalog&#32;-&#32;Random&#32;Geekery />
<meta itemprop="name" content=Ruby&#32;and&#32;the&#32;HYG&#32;Star&#32;Catalog&#32;-&#32;Random&#32;Geekery />
<meta name="application-name" content=Ruby&#32;and&#32;the&#32;HYG&#32;Star&#32;Catalog&#32;-&#32;Random&#32;Geekery />
<meta property="og:site_name" content="Random Geekery" />


<meta name="description" content="" />
<meta itemprop="description" content="" />
<meta property="og:description" content="" />
<meta name="twitter:description" content="" />


<base href="https://randomgeekery.org/post/2010/10/ruby-and-the-hyg-star-catalog/" />
<link rel="canonical" href="https://randomgeekery.org/post/2010/10/ruby-and-the-hyg-star-catalog/" itemprop="url" />
<meta name="url" content="https://randomgeekery.org/post/2010/10/ruby-and-the-hyg-star-catalog/" />
<meta name="twitter:url" content="https://randomgeekery.org/post/2010/10/ruby-and-the-hyg-star-catalog/" />
<meta property="og:url" content="https://randomgeekery.org/post/2010/10/ruby-and-the-hyg-star-catalog/" />


<meta property="og:updated_time" content=5010-05-12T100:00:10-0700 />


<link rel="sitemap" type="application/xml" title="Sitemap" href='https://randomgeekery.org/sitemap.xml' />

  <link
      rel="alternate"
      type="application/rss+xml"
    
        href="/index.xml"
    
      title="Random Geekery"/>



<meta name="robots" content="index,follow" />
<meta name="googlebot" content="index,follow" />


<meta name="twitter:site" content="" />
<meta name="twitter:creator" content="" />
<meta property="fb:admins" content="" />


<meta name="apple-mobile-web-app-title" content="Random Geekery" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />






<meta name="generator" content="Hugo 0.121.2">


    
    

<link
    rel="stylesheet"
    href="/css/style.fe9735814e6394fb590ff4fd2eb036a13152e6808ad90dd06ba181d89087b5d3.css"
    integrity="sha256-/pc1gU5jlPtZD/T9LrA2oTFS5oCK2Q3Qa6GB2JCHtdM=" 
    crossorigin="anonymous">


</head>

    <body class="">
        <div class="wrapper">
            <aside class="sidebar">
    <div class="container sidebar-sticky">
        <div class="light-dark" align="right">
    <button class="btn-light-dark" title="Toggle light/dark mode">
        <svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M6 .278a.768.768 0 0 1 .08.858a7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277c.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316a.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71C0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
        </svg>
        <svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M8 12a4 4 0 1 0 0-8a4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
        </svg>
    </button>
</div>

        <div class="sidebar-about">
    <h1 class="brand">
        
        
            <a href="https://randomgeekery.org">
                <h1>Random Geekery</h1>
            </a>
        
    </h1>
    <p class="lead">
    Collecting my attempts to improve at tech, art, and life
    </p>
</div>

        <nav>
    <ul class="sidebar-nav">
      
        <li class="bullet">
          <a href="/post/">Posts</a>
        </li>
      
        <li class="bullet">
          <a href="/card/">Cards</a>
        </li>
      
        <li class="bullet">
          <a href="/now/">Now</a>
        </li>
      
        <li class="bullet">
          <a href="/follow/">Follow</a>
        </li>
      
        <li class="bullet">
          <a href="/neighborhood/">Neighborhood</a>
        </li>
      
        <li class="bullet">
          <a href="/config/">Config</a>
        </li>
      
    </ul>
</nav>

        
  <div class="related">
    <div class="related-posts">
      <h3>Related</h3>
      <ul>
        
          <li><a href="/post/2011/07/rake/">Rake</a></li>
        
          <li><a href="/post/2007/10/jruby/">JRuby</a></li>
        
          <li><a href="/post/2004/10/drawing-celtic-knotwork/">Drawing Celtic Knotwork</a></li>
        
          <li><a href="/post/2004/09/look-at-the-latest-fark-headlines/">Look at the Latest Fark Headlines</a></li>
        
          <li><a href="/post/2004/09/the-mires/">The MIRES</a></li>
        
      </ul>
    </div>
  </div>



        
















        <p class="footnote">
powered by <a target="_blank" href="https://gohugo.io">Hugo</a> | themed with <a target="_blank" href="https://github.com/lukeorth/poison">poison</a>
    <br>
    &copy; 2024 Brian Wisti. All rights reserved.
</p>
<p class="footnote">
  This work is licensed under a
  <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
    Creative Commons Attribution 4.0 International License
  </a>.
</p>

  </div>
</aside>

            <main class="content container">
                <div class="post">
  <nav class="masthead">
    <ul>
    
  
    
  
    
  
    
  

    <li><a href="https://randomgeekery.org/">Random Geekery</a></li>
  

    <li><a href="https://randomgeekery.org/post/">Posts</a></li>
  

    <li><a href="https://randomgeekery.org/post/2010/">2010</a></li>
  

    <li><a class="active" href="https://randomgeekery.org/post/2010/10/ruby-and-the-hyg-star-catalog/">Ruby and the HYG Star Catalog</a></li>
</nav>



  <div class="info">
    <h1 class="post-title">
        <a href="https://randomgeekery.org/post/2010/10/ruby-and-the-hyg-star-catalog/">Ruby and the HYG Star Catalog</a>
    </h1>
    
        <time datetime="2010-10-05T00:00:00-0700" class="post-date">
            October 5, 2010
        </time>
    
    
    <ul class="tags">
        
        <li class="tag-ruby">
            <a href="https://randomgeekery.org/tags/ruby">ruby</a>
        </li>
        
        <li class="tag-coolnamehere">
            <a href="https://randomgeekery.org/tags/coolnamehere">coolnamehere</a>
        </li>
        
    </ul>
    
    
    
    
    
    
</div>

  <p>One of my big projects over the last year has been a <a href="/post/2009/07/parrot-babysteps/">Parrot Babysteps</a> tutorial. One of the more interesting tasks in that tutorial was <a href="/post/2009/10/parrot-babysteps-06-files-and-hashes/">reading a CSV file in Parrot</a>. I used the <a href="http://www.astronexus.com/node/34">HYG Star Catalog</a> as a sample <a href="/card/csv/">CSV</a> file that was large enough to present some interesting data. This was fun in <a href="/card/parrot/">Parrot</a>, but obviously I thought quite a bit about how I would tackle the problem in a higher level language such as <a href="/card/ruby/">Ruby</a>. Today seems like a good day to find out.</p>
<p>I am emphasizing the <em>Moderately</em> in this Moderately Interesting Ruby Exercise. After exploring the <code>csv</code> library for Ruby, we&rsquo;ll use <a href="http://sequel.rubyforge.org/">Sequel</a> to build a database that can be quickly queried. Even though I have an unhealthy love for making projects larger and more complex than they need to be, I want to keep this short and sweet.</p>
<h3 id="what-im-using">What I&rsquo;m Using</h3>
<p>My primary machine for these projects is the happy home iMac. It is running OS X 10.6 plus <a href="http://macports.org">MacPorts</a>. My default Ruby is 1.9.2, installed via <a href="http://rvm.beginrescueend.com/">rvm</a>.</p>
<p>I may revisit this exercise with other Ruby installations on other platforms to double-check that things work, but your results <em>should</em> be similar to mine as long as you are using Ruby 1.9.2.</p>
<h2 id="exploration">Exploration</h2>
<p>We will start by poking at the Ruby standard <code>csv</code> library a little bit, just to see how we use it. I already have a copy of the HYG Star Catalog from my previous efforts, but for this exercise I&rsquo;ll pretend I do not. We&rsquo;ll just download it using our favorite downloading technique. Mine is GNU <a href="http://www.gnu.org/software/wget/">wget</a>.</p>
<figure class="highlight">
  <pre tabindex="0"
    ><code class="language-" data-lang=""
      >$ wget http://www.astronexus.com/files/downloads/hygxyz.csv.gz
$ tar xfvz hygxyz.csv.gz</code></pre>
</figure><p>If we open <code>hygxyz.csv</code> in our favorite <em>Editor</em>, we will see that the file is large and bewildering.</p>
<figure class="highlight">
  <pre tabindex="0"
    ><code class="language-" data-lang=""
      >StarID,HIP,HD,HR,Gliese,BayerFlamsteed,ProperName,RA,Dec,Distance,PMRA,PMDec,RV,Mag,AbsMag,Spectrum,ColorIndex,X,Y,Z,VX,VY,VZ
0,,,,,,Sol,0,0,0.000004848,0,0,0,-26.73,4.85,G2V,0.656,0,0,0,0,0,0
1,1,224700,,,,,6.079e-05,01.08901332,282.485875706215,-5.20,-1.88,,9.10,1.84501631012894,F5,0.482,282.43485,0.00449,5.36884,4.9e-08,-7.12e-06,-2.574e-06
... and so on for 119,618 lines</code></pre>
</figure><p>There are many fields. Some of them are strings, others are numbers. Quite a few are empty.</p>
<h3 id="parsing-the-csv">Parsing the CSV</h3>
<p>Let&rsquo;s start with the simplest and dumbest CSV parsing code we can manage.</p>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="nb">require</span> <span class="s1">&#39;csv&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="no">CSV</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;hygxyz.csv&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span> <span class="nb">p</span> <span class="n">row</span> <span class="p">}</span></span></span></code></pre>
</figure><p>How does that look?</p>
<figure class="highlight">
  <pre tabindex="0"
    ><code class="language-" data-lang=""
      >$ ruby stellar
[&#34;StarID&#34;, &#34;HIP&#34;, &#34;HD&#34;, &#34;HR&#34;, &#34;Gliese&#34;, &#34;BayerFlamsteed&#34;, &#34;ProperName&#34;, &#34;RA&#34;, &#34;Dec&#34;, &#34;Distance&#34;, &#34;PMRA&#34;,
&#34;PMDec&#34;, &#34;RV&#34;, &#34;Mag&#34;, &#34;AbsMag&#34;, &#34;Spectrum&#34;, &#34;ColorIndex&#34;, &#34;X&#34;, &#34;Y&#34;, &#34;Z&#34;, &#34;VX&#34;, &#34;VY&#34;, &#34;VZ&#34;]
[&#34;0&#34;, nil, nil, nil, nil, nil, &#34;Sol&#34;, &#34;0&#34;, &#34;0&#34;, &#34;0.000004848&#34;, &#34;0&#34;, &#34;0&#34;, &#34;0&#34;, &#34;-26.73&#34;, &#34;4.85&#34;, &#34;G2V&#34;,
&#34;0.656&#34;, &#34;0&#34;, &#34;0&#34;, &#34;0&#34;, &#34;0&#34;, &#34;0&#34;, &#34;0&#34;]
[&#34;1&#34;, &#34;1&#34;, &#34;224700&#34;, nil, nil, nil, nil, &#34;6.079e-05&#34;, &#34;01.08901332&#34;, &#34;282.485875706215&#34;, &#34;-5.20&#34;, &#34;-1.88&#34;,
nil, &#34;9.10&#34;, &#34;1.84501631012894&#34;, &#34;F5&#34;, &#34;0.482&#34;, &#34;282.43485&#34;, &#34;0.00449&#34;, &#34;5.36884&#34;, &#34;4.9e-08&#34;, &#34;-7.12e-06&#34;,
&#34;-2.574e-06&#34;]
[&#34;2&#34;, &#34;2&#34;, &#34;224690&#34;, nil, nil, nil, nil, &#34;0.00025315&#34;, &#34;-19.49883745&#34;, &#34;45.662100456621&#34;, &#34;181.21&#34;,
&#34;-0.93&#34;, nil, &#34;9.27&#34;, &#34;5.97222057420059&#34;, &#34;K3V&#34;, &#34;0.999&#34;, &#34;43.04329&#34;, &#34;0.00285&#34;, &#34;-15.24144&#34;, &#34;-7.1e-08&#34;,
&#34;4.0112e-05&#34;, &#34;-1.94e-07&#34;]
[&#34;3&#34;, &#34;3&#34;, &#34;224699&#34;, nil, nil, nil, nil, &#34;0.00033386&#34;, &#34;38.85928608&#34;, &#34;355.871886120996&#34;, &#34;5.24&#34;, &#34;-2.91&#34;,
nil, &#34;6.61&#34;, &#34;-1.1464684004746&#34;, &#34;B9&#34;, &#34;-0.019&#34;, &#34;277.11358&#34;, &#34;0.02422&#34;, &#34;223.27753&#34;, &#34;3.148e-06&#34;,
&#34;9.04e-06&#34;, &#34;-3.909e-06&#34;]
...</code></pre>
</figure><p>Okay, wow. That is a lot of stuff going by. I don&rsquo;t know about you, but I&rsquo;m going to hit Control-C and make an adjustment to the code.</p>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="nb">require</span> <span class="s1">&#39;csv&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;hygxyz.csv&#39;</span>
</span></span><span class="line"><span class="cl"><span class="no">CSV</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span> <span class="nb">p</span> <span class="n">row</span> <span class="p">}</span></span></span></code></pre>
</figure><p>There. Now we will only look at the first three entries. That should be a little easier to digest. I also shuffled the filename into its own variable. That&rsquo;s just how I like to do things. I tell myself that it will be easier to read and edit later.</p>
<figure class="highlight">
  <pre tabindex="0"
    ><code class="language-" data-lang=""
      >$ ruby stellar
[&#34;StarID&#34;, &#34;HIP&#34;, &#34;HD&#34;, &#34;HR&#34;, &#34;Gliese&#34;, &#34;BayerFlamsteed&#34;, &#34;ProperName&#34;, &#34;RA&#34;, &#34;Dec&#34;, &#34;Distance&#34;, &#34;PMRA&#34;,
&#34;PMDec&#34;, &#34;RV&#34;, &#34;Mag&#34;, &#34;AbsMag&#34;, &#34;Spectrum&#34;, &#34;ColorIndex&#34;, &#34;X&#34;, &#34;Y&#34;, &#34;Z&#34;, &#34;VX&#34;, &#34;VY&#34;, &#34;VZ&#34;]
[&#34;0&#34;, nil, nil, nil, nil, nil, &#34;Sol&#34;, &#34;0&#34;, &#34;0&#34;, &#34;0.000004848&#34;, &#34;0&#34;, &#34;0&#34;, &#34;0&#34;, &#34;-26.73&#34;, &#34;4.85&#34;, &#34;G2V&#34;,
&#34;0.656&#34;, &#34;0&#34;, &#34;0&#34;, &#34;0&#34;, &#34;0&#34;, &#34;0&#34;, &#34;0&#34;]
[&#34;1&#34;, &#34;1&#34;, &#34;224700&#34;, nil, nil, nil, nil, &#34;6.079e-05&#34;, &#34;01.08901332&#34;, &#34;282.485875706215&#34;, &#34;-5.20&#34;, &#34;-1.88&#34;,
nil, &#34;9.10&#34;, &#34;1.84501631012894&#34;, &#34;F5&#34;, &#34;0.482&#34;, &#34;282.43485&#34;, &#34;0.00449&#34;, &#34;5.36884&#34;, &#34;4.9e-08&#34;, &#34;-7.12e-06&#34;,
&#34;-2.574e-06&#34;]</code></pre>
</figure><p>The default behavior for <code>csv</code> is reasonable. It split up the fields correctly, and set the empty fields to <code>nil</code>. Next we need to deal with the fact that the first row is supposed to be the header, providing names for
fields in the corresponding columns.</p>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="nb">require</span> <span class="s1">&#39;csv&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;hygxyz.csv&#39;</span>
</span></span><span class="line"><span class="cl"><span class="no">CSV</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="ss">headers</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span> <span class="nb">p</span> <span class="n">row</span> <span class="p">}</span></span></span></code></pre>
</figure><p>One small change has a big impact.</p>
<figure class="highlight">
  <pre tabindex="0"
    ><code class="language-" data-lang=""
      >$ ruby stellar.rb
#&lt;CSV::Row &#34;StarID&#34;:&#34;0&#34; &#34;HIP&#34;:nil &#34;HD&#34;:nil &#34;HR&#34;:nil &#34;Gliese&#34;:nil &#34;BayerFlamsteed&#34;:nil &#34;ProperName&#34;:&#34;Sol&#34;
&#34;RA&#34;:&#34;0&#34; &#34;Dec&#34;:&#34;0&#34; &#34;Distance&#34;:&#34;0.000004848&#34; &#34;PMRA&#34;:&#34;0&#34; &#34;PMDec&#34;:&#34;0&#34; &#34;RV&#34;:&#34;0&#34; &#34;Mag&#34;:&#34;-26.73&#34; &#34;AbsMag&#34;:&#34;4.85&#34;
&#34;Spectrum&#34;:&#34;G2V&#34; &#34;ColorIndex&#34;:&#34;0.656&#34; &#34;X&#34;:&#34;0&#34; &#34;Y&#34;:&#34;0&#34; &#34;Z&#34;:&#34;0&#34; &#34;VX&#34;:&#34;0&#34; &#34;VY&#34;:&#34;0&#34; &#34;VZ&#34;:&#34;0&#34;&gt;
#&lt;CSV::Row &#34;StarID&#34;:&#34;1&#34; &#34;HIP&#34;:&#34;1&#34; &#34;HD&#34;:&#34;224700&#34; &#34;HR&#34;:nil &#34;Gliese&#34;:nil &#34;BayerFlamsteed&#34;:nil &#34;ProperName&#34;:nil
&#34;RA&#34;:&#34;6.079e-05&#34; &#34;Dec&#34;:&#34;01.08901332&#34; &#34;Distance&#34;:&#34;282.485875706215&#34; &#34;PMRA&#34;:&#34;-5.20&#34; &#34;PMDec&#34;:&#34;-1.88&#34; &#34;RV&#34;:nil
&#34;Mag&#34;:&#34;9.10&#34; &#34;AbsMag&#34;:&#34;1.84501631012894&#34; &#34;Spectrum&#34;:&#34;F5&#34; &#34;ColorIndex&#34;:&#34;0.482&#34; &#34;X&#34;:&#34;282.43485&#34; &#34;Y&#34;:&#34;0.00449&#34;
&#34;Z&#34;:&#34;5.36884&#34; &#34;VX&#34;:&#34;4.9e-08&#34; &#34;VY&#34;:&#34;-7.12e-06&#34; &#34;VZ&#34;:&#34;-2.574e-06&#34;&gt;
#&lt;CSV::Row &#34;StarID&#34;:&#34;2&#34; &#34;HIP&#34;:&#34;2&#34; &#34;HD&#34;:&#34;224690&#34; &#34;HR&#34;:nil &#34;Gliese&#34;:nil &#34;BayerFlamsteed&#34;:nil &#34;ProperName&#34;:nil
&#34;RA&#34;:&#34;0.00025315&#34; &#34;Dec&#34;:&#34;-19.49883745&#34; &#34;Distance&#34;:&#34;45.662100456621&#34; &#34;PMRA&#34;:&#34;181.21&#34; &#34;PMDec&#34;:&#34;-0.93&#34; &#34;RV&#34;:nil
&#34;Mag&#34;:&#34;9.27&#34; &#34;AbsMag&#34;:&#34;5.97222057420059&#34; &#34;Spectrum&#34;:&#34;K3V&#34; &#34;ColorIndex&#34;:&#34;0.999&#34; &#34;X&#34;:&#34;43.04329&#34; &#34;Y&#34;:&#34;0.00285&#34;
&#34;Z&#34;:&#34;-15.24144&#34; &#34;VX&#34;:&#34;-7.1e-08&#34; &#34;VY&#34;:&#34;4.0112e-05&#34; &#34;VZ&#34;:&#34;-1.94e-07&#34;&gt;</code></pre>
</figure><p>Now <code>csv</code> is generating something that looks vaguely like a hash. Nice. However, every field is handled as a String when some of them are obviously numbers. The <code>converters</code> option should fix that.</p>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="no">CSV</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="ss">headers</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">converters</span><span class="p">:</span> <span class="ss">:numeric</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
</span></span><span class="line"><span class="cl">  <span class="nb">p</span> <span class="n">row</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span></span></span></code></pre>
</figure><p>Setting the <code>converters</code> option to <code>:numeric</code> tells CSV to convert anything that looks like a number to a Number. That is useful for comparing values, because Ruby won&rsquo;t automatically convert a String into a Number. You must tell it to convert. Anyways - I&rsquo;m babbling. It is really amazing how hard it is to pad the content of these little essays out when you are talking about Ruby code. That&rsquo;s probably why there are so many silly cartoons and insane gibberish accompanying the best Ruby tutorials.</p>
<figure class="highlight">
  <pre tabindex="0"
    ><code class="language-" data-lang=""
      >$ ruby stellar.rb
#&lt;CSV::Row &#34;StarID&#34;:0 &#34;HIP&#34;:nil &#34;HD&#34;:nil &#34;HR&#34;:nil &#34;Gliese&#34;:nil &#34;BayerFlamsteed&#34;:nil &#34;ProperName&#34;:&#34;Sol&#34; &#34;RA&#34;:0
&#34;Dec&#34;:0 &#34;Distance&#34;:4.848e-06 &#34;PMRA&#34;:0 &#34;PMDec&#34;:0 &#34;RV&#34;:0 &#34;Mag&#34;:-26.73 &#34;AbsMag&#34;:4.85 &#34;Spectrum&#34;:&#34;G2V&#34;
&#34;ColorIndex&#34;:0.656 &#34;X&#34;:0 &#34;Y&#34;:0 &#34;Z&#34;:0 &#34;VX&#34;:0 &#34;VY&#34;:0 &#34;VZ&#34;:0&gt;
#&lt;CSV::Row &#34;StarID&#34;:1 &#34;HIP&#34;:1 &#34;HD&#34;:224700 &#34;HR&#34;:nil &#34;Gliese&#34;:nil &#34;BayerFlamsteed&#34;:nil &#34;ProperName&#34;:nil
&#34;RA&#34;:6.079e-05 &#34;Dec&#34;:1.08901332 &#34;Distance&#34;:282.485875706215 &#34;PMRA&#34;:-5.2 &#34;PMDec&#34;:-1.88 &#34;RV&#34;:nil &#34;Mag&#34;:9.1
&#34;AbsMag&#34;:1.84501631012894 &#34;Spectrum&#34;:&#34;F5&#34; &#34;ColorIndex&#34;:0.482 &#34;X&#34;:282.43485 &#34;Y&#34;:0.00449 &#34;Z&#34;:5.36884
&#34;VX&#34;:4.9e-08 &#34;VY&#34;:-7.12e-06 &#34;VZ&#34;:-2.574e-06&gt;
#&lt;CSV::Row &#34;StarID&#34;:2 &#34;HIP&#34;:2 &#34;HD&#34;:224690 &#34;HR&#34;:nil &#34;Gliese&#34;:nil &#34;BayerFlamsteed&#34;:nil &#34;ProperName&#34;:nil
&#34;RA&#34;:0.00025315 &#34;Dec&#34;:-19.49883745 &#34;Distance&#34;:45.662100456621 &#34;PMRA&#34;:181.21 &#34;PMDec&#34;:-0.93 &#34;RV&#34;:nil &#34;Mag&#34;:9.27
&#34;AbsMag&#34;:5.97222057420059 &#34;Spectrum&#34;:&#34;K3V&#34; &#34;ColorIndex&#34;:0.999 &#34;X&#34;:43.04329 &#34;Y&#34;:0.00285 &#34;Z&#34;:-15.24144
&#34;VX&#34;:-7.1e-08 &#34;VY&#34;:4.0112e-05 &#34;VZ&#34;:-1.94e-07&gt;</code></pre>
</figure><p>Let&rsquo;s do something with those Numbers. How about counting the number of stars within ten light years of Earth?</p>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="c1"># count-neighbors.rb</span>
</span></span><span class="line"><span class="cl"><span class="nb">require</span> <span class="s1">&#39;csv&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;hygxyz.csv&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">neighbor_count</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="no">CSV</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="ss">headers</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">converters</span><span class="p">:</span> <span class="ss">:numeric</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="n">row</span><span class="o">[</span><span class="s1">&#39;Distance&#39;</span><span class="o">]</span> <span class="o">&lt;</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">    <span class="n">neighbor_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">puts</span> <span class="s2">&#34;There are </span><span class="si">#{</span><span class="n">neighbor_count</span><span class="si">}</span><span class="s2"> stars within 10 light years of Earth.&#34;</span></span></span></code></pre>
</figure><p>How many are there?</p>
<figure class="highlight">
  <pre tabindex="0"
    ><code class="language-" data-lang=""
      >$ ruby count-neighbors.rb
There are 320 stars within 10 light years of Earth.</code></pre>
</figure><p>That&rsquo;s a lot of neighbors. It took a while to count them, though. That probably has something to do with the 20 Megabyte CSV file. We are not ready to speed things up, though. Let&rsquo;s try one more task: looking for a specific star.</p>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="c1"># find-sol.rb</span>
</span></span><span class="line"><span class="cl"><span class="nb">require</span> <span class="s1">&#39;csv&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;hygxyz.csv&#39;</span>
</span></span><span class="line"><span class="cl"><span class="no">CSV</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="ss">headers</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">converters</span><span class="p">:</span> <span class="ss">:numeric</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="n">row</span><span class="o">[</span><span class="s1">&#39;ProperName&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&#34;Sol&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nb">p</span> <span class="n">row</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span></span></span></code></pre>
</figure><p>It better find our own Sun. It&rsquo;s the first entry, after all.</p>
<figure class="highlight">
  <pre tabindex="0"
    ><code class="language-" data-lang=""
      >$ ruby find-sol.rb
#&lt;CSV::Row &#34;StarID&#34;:0 &#34;HIP&#34;:nil &#34;HD&#34;:nil &#34;HR&#34;:nil &#34;Gliese&#34;:nil &#34;BayerFlamsteed&#34;:nil &#34;ProperName&#34;:&#34;Sol&#34; &#34;RA&#34;:0
&#34;Dec&#34;:0 &#34;Distance&#34;:4.848e-06 &#34;PMRA&#34;:0 &#34;PMDec&#34;:0 &#34;RV&#34;:0 &#34;Mag&#34;:-26.73 &#34;AbsMag&#34;:4.85 &#34;Spectrum&#34;:&#34;G2V&#34;
&#34;ColorIndex&#34;:0.656 &#34;X&#34;:0 &#34;Y&#34;:0 &#34;Z&#34;:0 &#34;VX&#34;:0 &#34;VY&#34;:0 &#34;VZ&#34;:0&gt;</code></pre>
</figure><p>Sorry, I got sleepy. Is it done? I should have put a <code>break</code> in that code after printing out the star details. Of course, that is just cheating around the fact that parsing a large CSV file is <em>slow</em>. Perhaps it is time to try a database.</p>
<h3 id="creating-a-database">Creating a Database</h3>
<p>I would imagine that stuffing these values into a database should make simple questions like &ldquo;show me the star named &lsquo;Sol&rsquo;&rdquo; or &ldquo;count the stars within 10 light years&rdquo; pretty straightforward. We can use a lightweight database such as <em>inbox/SQLite</em>. There may be nearly 120,000 stars in the catalog, but that is trivial for SQLite. I have heard anecdotal reports of it being used for tables with millions of rows.</p>
<p>First, I want to install <code>sqlite3</code>.</p>
<figure class="highlight">
  <pre tabindex="0"
    ><code class="language-" data-lang=""
      >$ port install sqlite3</code></pre>
</figure><p>I&rsquo;m not doing this on my <a href="http://ubuntu.com">Ubuntu</a> Linux machine, but if I was I&rsquo;d install both the <code>sqlite3</code> shell and the development libraries.</p>
<figure class="highlight">
  <pre tabindex="0"
    ><code class="language-" data-lang=""
      >$ sudo apt-get install sqlite3 libsqlite3-dev</code></pre>
</figure><h4 id="the-sequel-library">The Sequel Library</h4>
<p>I have already chosen Sequel as my preferred Ruby database library, so I need to install that. Oh, and I should also install <a href="http://rubyforge.org/projects/sqlite-ruby/">sqlite3-ruby</a>. Sequel provides a nice layer of abstraction, but it does not contain the code which actually speaks to the database.</p>
<figure class="highlight">
  <pre tabindex="0"
    ><code class="language-" data-lang=""
      >$ gem install sequel
$ gem install sqlite3-ruby</code></pre>
</figure><p>We can use the <code>create_table</code> database method described on the <a href="http://sequel.rubyforge.org/rdoc/files/doc/migration_rdoc.html">Sequel migrations</a> page to build the table, rather than relying on my rather lightweight knowledge of SQLite schema definition. The dump of star data from our earlier CSV parsing code provides the hints we need to build a usable schema.</p>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="nb">require</span> <span class="s1">&#39;csv&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nb">require</span> <span class="s1">&#39;sequel&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;hygxyz.csv&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="no">DB</span> <span class="o">=</span> <span class="no">Sequel</span><span class="o">.</span><span class="n">sqlite</span><span class="p">(</span><span class="s1">&#39;hyg.db&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="no">DB</span><span class="o">.</span><span class="n">table_exists?</span> <span class="ss">:stars</span>
</span></span><span class="line"><span class="cl">    <span class="no">DB</span><span class="o">.</span><span class="n">drop_table</span> <span class="ss">:stars</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="no">DB</span><span class="o">.</span><span class="n">create_table</span> <span class="ss">:stars</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="n">primary_key</span> <span class="ss">:id</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Integer</span> <span class="ss">:StarID</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Integer</span> <span class="ss">:HIP</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Integer</span> <span class="ss">:HD</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Integer</span> <span class="ss">:HR</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Integer</span> <span class="ss">:Gliese</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Integer</span> <span class="ss">:BayerFlamsteed</span>
</span></span><span class="line"><span class="cl">    <span class="nb">String</span>  <span class="ss">:ProperName</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Float</span>   <span class="ss">:RA</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Float</span>   <span class="ss">:Dec</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Float</span>   <span class="ss">:Distance</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Float</span>   <span class="ss">:PMRA</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Float</span>   <span class="ss">:PMDec</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Float</span>   <span class="ss">:RV</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Float</span>   <span class="ss">:Mag</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Float</span>   <span class="ss">:AbsMag</span>
</span></span><span class="line"><span class="cl">    <span class="nb">String</span>  <span class="ss">:Spectrum</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Float</span>   <span class="ss">:ColorIndex</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Float</span>   <span class="ss">:X</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Float</span>   <span class="ss">:Y</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Float</span>   <span class="ss">:Z</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Float</span>   <span class="ss">:VX</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Float</span>   <span class="ss">:VY</span>
</span></span><span class="line"><span class="cl">    <span class="nb">Float</span>   <span class="ss">:VZ</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="no">CSV</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="ss">headers</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">converters</span><span class="p">:</span> <span class="ss">:numeric</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span> <span class="s2">&#34;.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="no">DB</span><span class="o">[</span><span class="ss">:stars</span><span class="o">].</span><span class="n">insert</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">to_hash</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="nb">puts</span></span></span></code></pre>
</figure><p>This script will set up the database and fill it with values from the CSV file. Each row is converted to a Hash, which makes the database <code>insert</code> method happy. There is also a little check and cleanup near the beginning. This is just in case there is a typo that messes up your code later on. It doesn&rsquo;t hurt to be cautious.</p>
<figure class="highlight">
  <pre tabindex="0"
    ><code class="language-" data-lang=""
      >$ ruby stellar.rb
.......</code></pre>
</figure><p>Go take a break. Make some coffee, catch up with your family, or play one more turn of Civilization. This is going to take a while. Me, I went for some more coffee.</p>
<h3 id="searching-the-database">Searching the Database</h3>
<p>We will look at the <a href="http://sequel.rubyforge.org/rdoc/files/doc/querying_rdoc.html">Sequel querying API</a> in a moment, but first let us make sure that the database returns plausible results to direct queries.</p>
<figure class="highlight">
  <pre tabindex="0"
    ><code class="language-" data-lang=""
      >$ sqlite3 hyg.db
sqlite&gt; select count(*) from stars where distance &lt; 10;
320
sqlite&gt; select * from stars where propername = &#39;Sol&#39;;
1|0||||||Sol|0.0|0.0|4.848e-06|0.0|0.0|0.0|-26.73|4.85|G2V|0.656|0.0|0.0|0.0|0.0|0.0|0.0
sqlite&gt; .quit</code></pre>
</figure><p>Hopefully you noticed a big improvement in the speed of your searches by switching to a database. I sure did.</p>
<p>What if we tried the same queries with Ruby and Sequel? Let&rsquo;s open an <code>irb</code> prompt and test it out.</p>
<figure class="highlight">
  <pre tabindex="0"
    ><code class="language-" data-lang=""
      >$ irb
ruby-1.9.2-p0 &gt; require &#39;sequel&#39;
 =&gt; true
ruby-1.9.2-p0 &gt; DB = Sequel.sqlite(&#39;hyg.db&#39;)
 =&gt; #&lt;Sequel::SQLite::Database: &#34;sqlite:/hyg.db&#34;&gt;
ruby-1.9.2-p0 &gt; DB[:stars].first(ProperName: &#39;Sol&#39;)
 =&gt; {:id=&gt;1, :StarID=&gt;0, :HIP=&gt;nil, :HD=&gt;nil, :HR=&gt;nil, :Gliese=&gt;nil, :BayerFlamsteed=&gt;nil,
:ProperName=&gt;&#34;Sol&#34;, :RA=&gt;0.0, :Dec=&gt;0.0, :Distance=&gt;4.848e-06, :PMRA=&gt;0.0, :PMDec=&gt;0.0, :RV=&gt;0.0,
:Mag=&gt;-26.73, :AbsMag=&gt;4.85, :Spectrum=&gt;&#34;G2V&#34;, :ColorIndex=&gt;0.656, :X=&gt;0.0, :Y=&gt;0.0, :Z=&gt;0.0, :VX=&gt;0.0,
:VY=&gt;0.0, :VZ=&gt;0.0}
ruby-1.9.2-p0 &gt; DB[:stars].filter { distance &lt; 10 }.count
 =&gt; 320</code></pre>
</figure><p>Yes indeed. That was much faster. Let&rsquo;s close with something a little bit fancier: showing a table of information about all the stars in the catalog that are G Spectrum and have a proper name, ordered by their distance from Earth.</p>
<figure class="highlight">
  <pre tabindex="0"
    ><code class="language-" data-lang=""
      >ruby-1.9.2-p0 &gt; DB[:stars].filter(:Spectrum.like(&#39;G%&#39;)).filter(&#39;ProperName not null&#39;).order(:Distance).each { |row|
ruby-1.9.2-p0 &gt;     printf(&#34;%20s\t%4.2f\t%s\n&#34;, row[:ProperName], row[:Distance], row[:Spectrum])
ruby-1.9.2-p0 ?&gt;  }
              Sol    0.00    G2V
Rigel Kentaurus A    1.35    G2V
        82 G. Eri    6.06    G8V
 Groombridge 1830    9.16    G8Vp
     Vindemiatrix    31.35   G8IIIvar
            Nihal    48.80   G5II
=&gt; #&lt;Sequel::SQLite::Dataset: &#34;SELECT * FROM `stars` WHERE ((Spectrum like &#39;G%&#39;) AND (ProperName not null))&#34;&gt;</code></pre>
</figure><p>I encourage you to explore the Sequel querying API more on your own, but I need to wrap this up.</p>
<h2 id="conclusion">Conclusion</h2>
<p>All right. You&rsquo;ve got 119,617 stars with various characteristics, all sitting there waiting for you to think of something interesting to do with them. I just wanted to see how much easier it would be to parse a CSV in a high level language. Turns out, it&rsquo;s pretty easy. Explore the Ruby standard library and the <em>many</em> Rubygems that are available out in the big world. You&rsquo;ll probably have fun, and you&rsquo;ll almost definitely learn something.</p>
  






  <hr>
  

  
  
<hr>
<div class="footer">
    
    
      <a class="previous-post" href="https://randomgeekery.org/post/2010/09/thoughts-on-the-word-bra/?ref=footer">
        <span style="font-weight:bold;">« Previous</span>
        <br>Thoughts on the word &#34;Bra&#34;
      </a>
    
    
      <div class="next-post">
        <a href="https://randomgeekery.org/post/2010/10/parrot-babysteps-0e-parrot-namespaces/?ref=footer">
          <span style="font-weight:bold;">Next »</span>
          <br>Parrot Babysteps 0e - Parrot Namespaces
        </a>
      </div>
    
</div>

  
</div>
            </main>
            
  
    <div class="article-toc ">
    <div class="toc-wrapper">
      <h4 id="contents"></h4>
      <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#what-im-using">What I&rsquo;m Using</a></li>
      </ul>
    </li>
    <li><a href="#exploration">Exploration</a>
      <ul>
        <li><a href="#parsing-the-csv">Parsing the CSV</a></li>
        <li><a href="#creating-a-database">Creating a Database</a></li>
        <li><a href="#searching-the-database">Searching the Database</a></li>
      </ul>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
</div>

  

        </div><script defer data-domain="randomgeekery.org" src="https://plausible.io/js/script.js"></script>
    </body>
</html>

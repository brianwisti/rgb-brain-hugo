<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
    










    







<script defer language="javascript" type="text/javascript" src="/js/bundle.min.60856f0f2ed73fb3cd2820ee548c4698ffbc4d743736e852c0e27ce4f52dfd9c.js"></script>






    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <link rel="icon" href=/favicon.png>

    
    





  





  
  
  

<meta property="og:url" content="https://randomgeekery.org/post/2019/06/weighing-files-with-python/">
<meta property="og:title" content="Weighing Files With Python">
<meta name="twitter:title" content="Weighing Files With Python">


  <meta name="twitter:site" content="@brianwisti">



  
    <meta name="twitter:description" content="I want to optimize this site&#39;s file sizes, but first I should see if I need to.">
    <meta property="og:description" content="I want to optimize this site&#39;s file sizes, but first I should see if I need to.">
  



<title itemprop="name">Weighing Files With Python - Random Geekery</title>
<meta property="og:title" content=Weighing&#32;Files&#32;With&#32;Python&#32;-&#32;Random&#32;Geekery />
<meta name="twitter:title" content=Weighing&#32;Files&#32;With&#32;Python&#32;-&#32;Random&#32;Geekery />
<meta itemprop="name" content=Weighing&#32;Files&#32;With&#32;Python&#32;-&#32;Random&#32;Geekery />
<meta name="application-name" content=Weighing&#32;Files&#32;With&#32;Python&#32;-&#32;Random&#32;Geekery />
<meta property="og:site_name" content="Random Geekery" />


<meta name="description" content="I want to optimize this site&#39;s file sizes, but first I should see if I need to." />
<meta itemprop="description" content="I want to optimize this site&#39;s file sizes, but first I should see if I need to." />
<meta property="og:description" content="I want to optimize this site&#39;s file sizes, but first I should see if I need to." />
<meta name="twitter:description" content="I want to optimize this site&#39;s file sizes, but first I should see if I need to." />


<base href="https://randomgeekery.org/post/2019/06/weighing-files-with-python/" />
<link rel="canonical" href="https://randomgeekery.org/post/2019/06/weighing-files-with-python/" itemprop="url" />
<meta name="url" content="https://randomgeekery.org/post/2019/06/weighing-files-with-python/" />
<meta name="twitter:url" content="https://randomgeekery.org/post/2019/06/weighing-files-with-python/" />
<meta property="og:url" content="https://randomgeekery.org/post/2019/06/weighing-files-with-python/" />


<meta property="og:updated_time" content=1006-01-12T60:00:19-0700 />


<link rel="sitemap" type="application/xml" title="Sitemap" href='https://randomgeekery.org/sitemap.xml' />

  <link
      rel="alternate"
      type="application/rss+xml"
    
        href="/index.xml"
    
      title="Random Geekery"/>



<meta name="robots" content="index,follow" />
<meta name="googlebot" content="index,follow" />


<meta name="twitter:site" content="" />
<meta name="twitter:creator" content="" />
<meta property="fb:admins" content="" />


<meta name="apple-mobile-web-app-title" content="Random Geekery" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />






<meta name="generator" content="Hugo 0.121.2">


    
    

<link
    rel="stylesheet"
    href="/css/style.fe9735814e6394fb590ff4fd2eb036a13152e6808ad90dd06ba181d89087b5d3.css"
    integrity="sha256-/pc1gU5jlPtZD/T9LrA2oTFS5oCK2Q3Qa6GB2JCHtdM=" 
    crossorigin="anonymous">


</head>

    <body class="">
        <div class="wrapper">
            <aside class="sidebar">
    <div class="container sidebar-sticky">
        <div class="light-dark" align="right">
    <button class="btn-light-dark" title="Toggle light/dark mode">
        <svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M6 .278a.768.768 0 0 1 .08.858a7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277c.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316a.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71C0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
        </svg>
        <svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M8 12a4 4 0 1 0 0-8a4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
        </svg>
    </button>
</div>

        <div class="sidebar-about">
    <h1 class="brand">
        
        
            <a href="https://randomgeekery.org">
                <h1>Random Geekery</h1>
            </a>
        
    </h1>
    <p class="lead">
    Collecting my attempts to improve at tech, art, and life
    </p>
</div>

        <nav>
    <ul class="sidebar-nav">
      
        <li class="bullet">
          <a href="/follow/">Follow</a>
        </li>
      
        <li class="bullet">
          <a href="/now/">Now</a>
        </li>
      
    </ul>
</nav>

        
  <div class="related">
    <div class="related-posts">
      <h3>Related</h3>
      <ul>
        
          <li><a href="/post/2013/11/my-own-ruby-fibers-babystep/">My Own Ruby Fibers Babystep</a></li>
        
          <li><a href="/post/2019/12/dwim-is-consistent/">DWIM is consistent</a></li>
        
          <li><a href="/post/2019/11/directory-listings-with-crystal/">Directory Listings With Crystal</a></li>
        
          <li><a href="/post/2019/11/summarizing-a-file-with-crystal/">Summarizing A File With Crystal</a></li>
        
          <li><a href="/post/2019/01/circular-grids-with-python-and-pillow/">Circular Grids With Python and Pillow</a></li>
        
      </ul>
    </div>
  </div>



        
















        <p class="footnote">
powered by <a target="_blank" href="https://gohugo.io">Hugo</a> | themed with <a target="_blank" href="https://github.com/lukeorth/poison">poison</a>
    <br>
    &copy; 2024 Brian Wisti. All rights reserved.
</p>
<p class="footnote">
  This work is licensed under a
  <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
    Creative Commons Attribution 4.0 International License
  </a>.
</p>

  </div>
</aside>

            <main class="content container">
                <div class="post">
  <nav class="masthead">
    <ul>
    
  
    
  
    
  
    
  

    <li><a href="https://randomgeekery.org/">Random Geekery</a></li>
  

    <li><a href="https://randomgeekery.org/post/">Posts</a></li>
  

    <li><a href="https://randomgeekery.org/post/2019/">2019</a></li>
  

    <li><a class="active" href="https://randomgeekery.org/post/2019/06/weighing-files-with-python/">Weighing Files With Python</a></li>
</nav>



  <div class="info">
    <h1 class="post-title">
        <a href="https://randomgeekery.org/post/2019/06/weighing-files-with-python/">Weighing Files With Python</a>
    </h1>
    
        <time datetime="2019-06-01T00:00:00-0700" class="post-date">
            June 1, 2019
        </time>
    
    
    <ul class="tags">
        
        <li class="tag-python">
            <a href="https://randomgeekery.org/tags/python">python</a>
        </li>
        
        <li class="tag-site">
            <a href="https://randomgeekery.org/tags/site">site</a>
        </li>
        
        <li class="tag-files">
            <a href="https://randomgeekery.org/tags/files">files</a>
        </li>
        
        <li class="tag-programming">
            <a href="https://randomgeekery.org/tags/programming">programming</a>
        </li>
        
    </ul>
    
    
    
    
    
    
</div>

  <p><img src="/post/2019/06/../../../attachments/img/2019/cover-2019-06-01.png" alt="attachments/img/2019/cover-2019-06-01.png"/></p>
<h2 id="the-idea">The idea</h2>
<p>I got an idea in my head a while ago to reduce image sizes for the site. Some of my drawings and photos are a little big. On a slower connection, a visitor could spend a while waiting. And if their bandwidth is metered? Oh I’d hate to think one of my sketches was what put their account over the cap, or got their account throttled to Edge speeds for the rest of the month.</p>
<p>I know I can make it better.</p>
<h2 id="the-problem-with-my-idea">The problem with my idea</h2>
<p>Well, I don’t <em>really</em> know. I suspect a handful of files are big, but how many files? How big? Big for who? And what about after I do the work? What is less than big? How will I know what work to do, and how will I know the effectiveness of what work when I’m done?</p>
<p><a href="https://anonymoushash.vmbrasseur.com/">VM Brasseur</a> gives excellent advice on many topics. One tip sticks in my head: I need numbers for my accomplishments. Heck, right now I need numbers to see if this accomplishment is necessary.</p>
<h2 id="what-numbers-should-i-care-about">What numbers <em>should</em> I care about?</h2>
<p>Of course the problem with data is that there is so much of it. What should I care about, if the goal is making a visit easier for visitors on limited connections?</p>
<h3 id="file-size">File size</h3>
<p>This is the more obvious and easily measured. This site (and most others) consists of files, right? Text files, image files, the occasional video file. All else being equal, a file that takes up more storage will also take more time to download.</p>
<p>&ldquo;All else being equal&rdquo; gets a little tricky though.</p>
<h3 id="latency">Latency</h3>
<p>How long does it take for the user to see something useful when interacting with your site? (loading a page, clicking a link, doing things with web apps). It’s affected by – well, everything really. Network speed, server resources, sunspots.</p>
<p>If latency is high enough, one big file may reach a visitor quicker than a dozen small requests. If they spend too long waiting for too many pieces, they’ll go elsewhere in a heartbeat.</p>
<p>This <a href="https://twitter.com/tacertain/status/1132391299733000193">Twitter thread</a> by Andrew Certain provides an interesting look at how a large organization like Amazon takes latency seriously. It’s far deeper than I plan to measure, but it might help build more context.</p>
<p>Unfortunately latency can be hard to predict for one person with a blog. I do not yet know what tools work best for evaluating the effect of latency on site performance.</p>
<p>There are some easily found tools. <a href="https://developers.google.com/web/tools/chrome-devtools/network/#throttle">Chrome</a> and <a href="https://developer.mozilla.org/en-US/docs/Tools/Network_Monitor/Throttling">Firefox</a> both include tools to &ldquo;throttle&rdquo; – simulating different network conditions.</p>
<p><img src="/post/2019/06/attachments/img/2019/firefox-throttled-3g-kitty.png" alt="Firefox Developer Tools network tab with throttling at 3G"/></p>
<p>This is helpful on a page-by-page basis, and probably <em>very</em> helpful for evaluating a single page application. It doesn’t translate easily to checking an entire site. I suppose I could use <a href="https://github.com/tylertreat/Comcast">Comcast</a>, a command line tool for &ldquo;simulating shitty network conditions&rdquo; and maybe <a href="https://httpie.org/">HTTPie</a> to crawl the site under those conditions.</p>
<blockquote>
<p><strong>NOTE</strong></p>
<p>Brian, stop. This is taking you into the world of resilience testing and <a href="https://en.wikipedia.org/wiki/Chaos_engineering">chaos engineering</a>, which sounds <em>awesome</em> and has a wealth of tools already written. It also sounds completely unnecessary for this humble little blog.</p>
<p>&ldquo;Pick your battles&rdquo; is another truism that applies here.</p>
</blockquote>
<p>We’ll ignore latency for now. Besides, I’ve already managed many major elements of latency. <a href="https://gohugo.io">Hugo</a> creates a static site. Every page already exists by the time you visit. No extra time needed for database lookups or constructing views. I use AWS <a href="https://aws.amazon.com/s3/">S3</a> to host, and <a href="https://aws.amazon.com/cloudfront/">Cloudfront</a> as a <a href="https://www.cloudflare.com/learning/cdn/what-is-a-cdn/">CDN</a>. This is probably the fastest and most reliable approach possible with my resources.</p>
<p>I <em>do</em> have an issue with the CDN not promptly updating some files when I upload the site, but I’m working on that.</p>
<h2 id="measuring-file-sizes">Measuring file sizes</h2>
<p>I could just pick an arbitrary threshold and find every file bigger than that with a <a href="/card/perl/">card/Perl</a> one-liner using <a href="https://metacpan.org/pod/File::Find::Rule">File::Find::Rule</a>&rsquo;s <a href="https://metacpan.org/pod/distribution/File-Find-Rule/lib/File/Find/Rule/Procedural.pod">procedural</a> flavor.</p>
<figure class="highlight">
  <pre tabindex="0"
    ><code class="language-" data-lang=""
      >$ perl -MFile::Find::Rule -E &#39;say for find(file =&gt; size =&gt; &#34;&gt; 6M&#34; =&gt; in =&gt; &#34;public&#34;);&#39;
public/2015/08/01/zentangle-doodle/cover.png
public/2017/04/22/kalaidoscope-symmetry/cover.jpg
public/2017/11/07/something-colorful/cover.jpg
public/2019/04/14/psychedelic-playing-card/cover.png
public/2018/09/30/cougar-mountain/fantastic-erratic.jpg
public/2018/09/30/cougar-mountain/old-stump.jpg
public/2018/09/30/cougar-mountain/mossy.jpg
public/2018/09/30/cougar-mountain/tall-stump.jpg
public/2018/09/30/cougar-mountain/cover.jpg</code></pre>
</figure><p>Or maybe find the median between my biggest and smallest files, flagging everything bigger than the median. I promised <a href="/card/python/">card/Python</a> in the tags, so let’s move away from Perl.</p>
<p><strong><code>median.py</code></strong></p>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-python" data-lang="python"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">attr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@attr.s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">FileWeight</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Knows how much a file weighs&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">size</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">files_seen</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="s2">&#34;public&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">filesize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">files_seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FileWeight</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">filesize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">smallest</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">files_seen</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">fw</span><span class="p">:</span> <span class="n">fw</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">largest</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">files_seen</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">fw</span><span class="p">:</span> <span class="n">fw</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">median</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="p">(</span><span class="n">smallest</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">largest</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">    <span class="n">biggest_half</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files_seen</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">median</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">biggest_half</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span></span></span></code></pre>
</figure><p>I know Python 3.7 has <a href="https://docs.python.org/3/library/dataclasses.html">data classes</a>. I like <a href="https://www.attrs.org">attrs</a>, which supports type hinting while still working on older versions of the language.</p>
<p>Running this gives me the same files as my one-liner. Good choice for an arbitrary number, right?</p>
<figure class="highlight">
  <pre tabindex="0"
    ><code class="language-" data-lang=""
      >$ python median.py
FileWeight(path=&#39;public/2015/08/01/zentangle-doodle/cover.png&#39;, size=8964751)
FileWeight(path=&#39;public/2017/04/22/kalaidoscope-symmetry/cover.jpg&#39;, size=7729604)
FileWeight(path=&#39;public/2017/11/07/something-colorful/cover.jpg&#39;, size=9594815)
FileWeight(path=&#39;public/2019/04/14/psychedelic-playing-card/cover.png&#39;, size=13088396)
FileWeight(path=&#39;public/2018/09/30/cougar-mountain/fantastic-erratic.jpg&#39;, size=7114429)
FileWeight(path=&#39;public/2018/09/30/cougar-mountain/old-stump.jpg&#39;, size=7672471)
FileWeight(path=&#39;public/2018/09/30/cougar-mountain/mossy.jpg&#39;, size=6639527)
FileWeight(path=&#39;public/2018/09/30/cougar-mountain/tall-stump.jpg&#39;, size=7052340)
FileWeight(path=&#39;public/2018/09/30/cougar-mountain/cover.jpg&#39;, size=8412560)</code></pre>
</figure><p>I learned that this technique of grabbing everything on one side of the median is called a &ldquo;median split.&rdquo; I also learned that however convenient it might be, a median split doesn’t <em>mean</em> anything. It’s the value halfway between two numbers. Is it a big download size? Maybe. What if I have a bunch of 5.9MB files? Those would be kind of big too, right? If I keep optimizing the biggest half and the median steadily moves down, how will I know when I’m done? What’s a small download?</p>
<p>Okay. I’m okay. I need to breathe for a minute. Once you start asking questions, it can be hard to stop.</p>
<p>So I need to know what the numbers mean, and what a good threshold is. Come to think of it, there might be a few thresholds.</p>
<h2 id="estimating-download-time">Estimating download time</h2>
<p>I care about how long it takes to download a file, assuming latency is as good as it’s going to get. The file size is one part of the download question. The visitor’s connection is the other part. I usually have a nice high speed connection, but not always.</p>
<p>Often I’m on LTE with one bar. Sometimes I’m on 3G. Very occasionally I find a dark corner that only gets me an Edge connection.</p>
<p>Sometimes I have no connection at all, but site optimization can’t help with that.</p>
<p>The <a href="https://developer.mozilla.org/en-US/docs/Tools/Network_Monitor/Throttling">Firefox</a> throttling tool documentation includes a chart specifying what its selections represent. I know from site analytics that a third of my visitors use mobile devices. I don’t know what their connection speed is, but I find myself on 3G often enough that I think &ldquo;Regular 3G&rdquo; is an acceptable choice.</p>
<p>That 750 Kbps number represents 750,000 bits. There are eight bits in a byte. Divide 750,000 by eight and that’s only 93,750 bytes per second. The site’s median size of roughly six megabytes suddenly feels a lot bigger.</p>
<p>Let’s teach the FileWeight class to estimate downloads. I’ll clarify its printed details while I’m at it.</p>
<p><strong><code>download-time.py</code></strong></p>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">attr</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">DOWNLOAD_SPEED</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">750_000</span> <span class="c1"># bits per second</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">describe_size</span><span class="p">(</span><span class="n">byte_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Use common notation to describe a byte count&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">scales</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="s2">&#34;GB&#34;</span><span class="p">),</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="s2">&#34;MB&#34;</span><span class="p">),</span> <span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="s2">&#34;KB&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">multiple</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">scales</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">byte_count</span> <span class="o">&gt;</span> <span class="n">multiple</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">converted</span> <span class="o">=</span> <span class="n">byte_count</span> <span class="o">/</span> <span class="n">multiple</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">converted</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">byte_count</span><span class="si">}</span><span class="s2"> bytes&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@attr.s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">FileWeight</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Knows how much a file weighs&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">size</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">download_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bps</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;How many seconds to download this file at a given rate&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">bytes_per_second</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">bps</span> <span class="o">/</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="n">bytes_per_second</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">size</span> <span class="o">=</span> <span class="n">describe_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">time_3g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_time</span><span class="p">(</span><span class="n">DOWNLOAD_SPEED</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&gt; (</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2">) 3g=</span><span class="si">{</span><span class="n">time_3g</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ...</span></span></span></code></pre>
</figure><p>The script is still focusing on the median, but the extra information should give us a little context.</p>
<figure class="highlight">
  <pre tabindex="0"
    ><code class="language-" data-lang=""
      >$ python download-time.py
&lt;public/2015/08/01/zentangle-doodle/cover.png&gt; (8.55 MB) 3g=95.624s
&lt;public/2017/04/22/kalaidoscope-symmetry/cover.jpg&gt; (7.37 MB) 3g=82.449s
&lt;public/2017/11/07/something-colorful/cover.jpg&gt; (9.15 MB) 3g=102.345s
&lt;public/2019/04/14/psychedelic-playing-card/cover.png&gt; (12.48 MB) 3g=139.610s
&lt;public/2018/09/30/cougar-mountain/fantastic-erratic.jpg&gt; (6.78 MB) 3g=75.887s
&lt;public/2018/09/30/cougar-mountain/old-stump.jpg&gt; (7.32 MB) 3g=81.840s
&lt;public/2018/09/30/cougar-mountain/mossy.jpg&gt; (6.33 MB) 3g=70.822s
&lt;public/2018/09/30/cougar-mountain/tall-stump.jpg&gt; (6.73 MB) 3g=75.225s
&lt;public/2018/09/30/cougar-mountain/cover.jpg&gt; (8.02 MB) 3g=89.734s</code></pre>
</figure><p>Oh that’s not good. The biggest file would take almost two and a half minutes to download, while the smallest above the median would still take over a minute. That’s on top of whatever else is on the page.</p>
<p>My threshold should be far less than the median. How much less?</p>
<h3 id="picking-my-thresholds">Picking my thresholds</h3>
<p>Jakob Nielsen <a href="https://www.nngroup.com/articles/response-times-3-important-limits/">summarized</a> how different response times feel to a user when interacting with an application – and yes, loading a post from your blog in a browser is interacting with an application, affected by the browser <em>and</em> your site (and the network, and so on).</p>
<ul>
<li>less than <em>0.1 seconds</em> is fast enough that it feels like they’re doing it themselves</li>
<li>less than <em>1 second</em> is slow enough that it feels like they’re telling the computer to do something</li>
<li>less than <em>10 seconds</em> is so slow that you’re starting to lose their attention</li>
</ul>
<p>Beyond ten seconds and you’re wrestling with the limits of a normal human brain that already has plenty of stuff to think about.</p>
<p>I can and do make excuses –</p>
<ul>
<li>&ldquo;They probably came here on purpose, so they’ll wait!&rdquo;</li>
<li>&ldquo;This is so cool that they won’t mind waiting!&rdquo;</li>
<li>&ldquo;So many factors are beyond my control that there’s no point worrying about it.&rdquo;</li>
<li>&ldquo;Everybody else’s site is even worse!&rdquo;</li>
</ul>
<p>– but no. The first two are lies from my ego, the last two are <em>terrible</em> arguments from my apathy.</p>
<p>I know my thresholds. Let’s teach FileWeight about them so it can report the news.</p>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">DOWNLOAD_EXPRESSIONS</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;excessive&#34;</span><span class="p">:</span> <span class="s2">&#34;🙁&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;slow&#34;</span><span class="p">:</span> <span class="s2">&#34;😐&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;ok&#34;</span><span class="p">:</span> <span class="s2">&#34;😊&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;instant&#34;</span><span class="p">:</span> <span class="s2">&#34;😁&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@attr.s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">FileWeight</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">size</span> <span class="o">=</span> <span class="n">describe_size</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">time_3g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">describe_3g</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">time_3g</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_excessive</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">describe_3g</span> <span class="o">+=</span> <span class="n">DOWNLOAD_EXPRESSIONS</span><span class="p">[</span><span class="s2">&#34;excessive&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_slow</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">describe_3g</span> <span class="o">+=</span> <span class="n">DOWNLOAD_EXPRESSIONS</span><span class="p">[</span><span class="s2">&#34;slow&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ok</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">describe_3g</span> <span class="o">+=</span> <span class="n">DOWNLOAD_EXPRESSIONS</span><span class="p">[</span><span class="s2">&#34;ok&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_instant</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">            <span class="n">describe_3g</span> <span class="o">+=</span> <span class="n">DOWNLOAD_EXPRESSIONS</span><span class="p">[</span><span class="s2">&#34;instant&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">&gt; (</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s2">) 3g=</span><span class="si">{</span><span class="n">describe_3g</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">is_excessive</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">10.0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">is_slow</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mf">1.0</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_time</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mf">10.0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">is_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mf">0.1</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_time</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mf">1.0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">is_instant</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">download_time</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mf">0.1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">files_seen</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="s2">&#34;public&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">filesize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">files_seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FileWeight</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">filesize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># I got bored of looking at the same files</span>
</span></span><span class="line"><span class="cl">    <span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl">    <span class="n">selection</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">files_seen</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span></span></span></code></pre>
</figure><p>I also added a little emoji quick reference so I can tell at a glance the expected user reaction at the file’s download rate.</p>
<figure class="highlight">
  <pre tabindex="0"
    ><code class="language-" data-lang=""
      >$ python download-time.py
&lt;public/2018/12/31/hopepunk-for-2019/cover_hu302a359ad2f64a42481affbc4fbbb8c4_4191368_1000x0_resize_q75_linear.jpg&gt; (156.96 KB) 3g=1.714s😐
&lt;public/2018/10/27/winter-hat-and-gloves/cover_hu42513aeed6d773f768448596f8f497f6_2320770_1000x0_resize_q75_linear.jpg&gt; (182.43 KB) 3g=1.993s😐
&lt;public/tags/pagetemplate/index.xml&gt; (128.25 KB) 3g=1.401s😐
&lt;public/2018/05/26/crafts-are-now-posts/index.html&gt; (17.27 KB) 3g=0.189s😊
&lt;public/2001/01/17/python/index.html&gt; (6.44 KB) 3g=0.070s😁
&lt;public/post/2013/fickle/index.html&gt; (328 bytes) 3g=0.003s😁
&lt;public/2018/08/11/satellite/satellite-lines-black.jpg&gt; (476.27 KB) 3g=5.202s😐
&lt;public/coolnamehere/2007/04/19_01-handling-a-single-round.html&gt; (469 bytes) 3g=0.005s😁
&lt;public/2018/08/19/island-center-forest/mossy-trees.jpg&gt; (3.56 MB) 3g=39.789s🙁
&lt;public/2008/10/01/natalies-hat/cover.jpg&gt; (84.94 KB) 3g=0.928s😊</code></pre>
</figure><p>Plenty of build process artifacts in there. The long image names come from using Hugo <a href="https://gohugo.io/content-management/image-processing/">image processing</a> functions for thumbnails and inline images. I also have many tiny redirect files, letting Hugo’s
<a href="https://gohugo.io/content-management/urls/#aliases/">aliasing</a> behavior make up for the site’s inconsistent organization over time.</p>
<p>A FileWeight object can now describe the details I care about for a single file, including where it fits in the attention span thresholds. How many of my files are too big?</p>
<h2 id="putting-it-all-together">Putting it all together</h2>
<p>Ideally I would measure all the files associated with each post – HTML, CSS, fonts, JavaScript if any, and images – then add those together for a total page weight. Someday I may even do that! Not today, though. Today I focus on information about downloading each file individually. This post is long enough already.</p>
<h3 id="all-the-files">All the files</h3>
<p><strong><code>report-weight.py</code></strong></p>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">describe_speed</span><span class="p">(</span><span class="n">bit_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Use common notation to describe a baud rate&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">scales</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="s2">&#34;Gbps&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="s2">&#34;Mbps&#34;</span><span class="p">),</span> <span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="s2">&#34;Kbps&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">multiple</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">scales</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">bit_count</span> <span class="o">&gt;</span> <span class="n">multiple</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">converted</span> <span class="o">=</span> <span class="n">bit_count</span> <span class="o">/</span> <span class="n">multiple</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">converted</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">bit_count</span><span class="si">}</span><span class="s2"> bps&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@attr.s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SiteWeight</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Reports download information for all files in the site&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">public_dir</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">files</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">FileWeight</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">attr</span><span class="o">.</span><span class="n">Factory</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_files</span><span class="p">(),</span> <span class="n">takes_self</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_load_files</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">FileWeight</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Gather FileWeight info for every visible file on the site&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">files_seen</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">public_dir</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">filesize</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">files_seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FileWeight</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">filesize</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">files_seen</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_build_download_table</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Build cells of a download estimate table&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">excessive_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_excessive</span><span class="p">()])</span>
</span></span><span class="line"><span class="cl">        <span class="n">slow_max</span> <span class="o">=</span> <span class="n">describe_size</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">DOWNLOAD_SPEED</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">ok_max</span> <span class="o">=</span> <span class="n">describe_size</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">DOWNLOAD_SPEED</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">instant_max</span> <span class="o">=</span> <span class="n">describe_size</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">DOWNLOAD_SPEED</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">slow_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_slow</span><span class="p">()])</span>
</span></span><span class="line"><span class="cl">        <span class="n">ok_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_ok</span><span class="p">()])</span>
</span></span><span class="line"><span class="cl">        <span class="n">instant_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_instant</span><span class="p">()])</span>
</span></span><span class="line"><span class="cl">        <span class="n">download_table</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;excessive&#34;</span><span class="p">,</span> <span class="s2">&#34;&gt; 10s&#34;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;&gt; </span><span class="si">{</span><span class="n">slow_max</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">excessive_count</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;slow&#34;</span><span class="p">,</span> <span class="s2">&#34;1s - 10s&#34;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">ok_max</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">slow_max</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">slow_count</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;ok&#34;</span><span class="p">,</span> <span class="s2">&#34;0.1s - 1s&#34;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">instant_max</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">ok_max</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">ok_count</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;instant&#34;</span><span class="p">,</span> <span class="s2">&#34;≤ 0.1s&#34;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;≤ </span><span class="si">{</span><span class="n">instant_max</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">instant_count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">download_table</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">print_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Format and display a summary of download estimates&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;All files in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">public_dir</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">file_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">total_bytes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">total_size</span> <span class="o">=</span> <span class="n">describe_size</span><span class="p">(</span><span class="n">total_bytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">file_count</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> files (</span><span class="si">{</span><span class="n">total_size</span><span class="si">}</span><span class="s2">)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">speed</span> <span class="o">=</span> <span class="n">describe_speed</span><span class="p">(</span><span class="n">DOWNLOAD_SPEED</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Download guesses for </span><span class="si">{</span><span class="n">speed</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">download_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_download_table</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">size_range</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">download_table</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">expression</span> <span class="o">=</span> <span class="n">DOWNLOAD_EXPRESSIONS</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34; </span><span class="si">{</span><span class="n">expression</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">description</span><span class="si">:</span><span class="s2"> &lt;10</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">size_range</span><span class="si">:</span><span class="s2"> &lt;26</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">count</span><span class="si">:</span><span class="s2"> &gt;6,</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">site</span> <span class="o">=</span> <span class="n">SiteWeight</span><span class="p">(</span><span class="s2">&#34;public&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">site</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span></span></span></code></pre>
</figure><p>I spent too much time on that download table. I could have spent even more, sizing each column to the longest field and <em>anyways</em> that wasn’t the point. Let’s look at my download estimates.</p>
<figure class="highlight">
  <pre tabindex="0"
    ><code class="language-" data-lang=""
      >$ python report-weight.py
All files in public
1,886 files (418.71 MB)
Download guesses for 750.00 Kbps
 🙁 &gt; 10s      &gt; 915.53 KB                   111
 😐 1s - 10s   91.55 KB - 915.53 KB          269
 😊 0.1s - 1s  9.16 KB - 91.55 KB            611
 😁 ≤ 0.1s     ≤ 9.16 KB                     895</code></pre>
</figure><p>Way too many files take more than ten seconds to load. I know better than to be pleased about the large number of files that load instantly. As I mentioned, quite a few of them are redirects. On the latency side of things those are <em>worse</em> because the visitor then has to load the real post.</p>
<p>I also said I’m not worrying about latency today.</p>
<p>The median list was helpful in showing me that my biggest offenders are image files, so what about adding a report on those?</p>
<h3 id="just-the-media-files">Just the media files</h3>
<p>The easiest way would be to base it off file extension. But that ends up looking a bit untidy, because extensions have accumulated over the years. JPEG files are the worst offender, being stored as <code>.jpeg</code>, <code>.jpg</code>, and even <code>.JPG</code>.</p>
<p>I’ll use the standard <a href="https://docs.python.org/3/library/mimetypes.html#mimetypes.guess_type">mimetypes</a> library instead. FileWeight can use that to guess what kind of file it’s looking at, and SiteWeight will make another download table for media files. It still uses file extensions, but with a smarter list than what I could build.</p>
<p><strong><code>weight-with-media.py</code></strong></p>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># ...</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">mimetypes</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Tell mimetypes about nonstandard files it may find.</span>
</span></span><span class="line"><span class="cl"><span class="n">mimetypes</span><span class="o">.</span><span class="n">add_type</span><span class="p">(</span><span class="s2">&#34;text/plain&#34;</span><span class="p">,</span> <span class="s1">&#39;.map&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@attr.s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">FileWeight</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">    <span class="n">filetype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">attr</span><span class="o">.</span><span class="n">Factory</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_guess_filetype</span><span class="p">(),</span> <span class="n">takes_self</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_guess_filetype</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">mimetype</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mimetypes</span><span class="o">.</span><span class="n">guess_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">mimetype</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">is_media</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;is this an image or video?&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filetype</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;/&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&#34;image&#34;</span><span class="p">,</span> <span class="s2">&#34;video&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@attr.s</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">SiteWeight</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">_build_download_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">:</span> <span class="n">List</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Build cells of a download estimate table&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">excessive_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_excessive</span><span class="p">()])</span>
</span></span><span class="line"><span class="cl">        <span class="n">slow_max</span> <span class="o">=</span> <span class="n">describe_size</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">DOWNLOAD_SPEED</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">ok_max</span> <span class="o">=</span> <span class="n">describe_size</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">DOWNLOAD_SPEED</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">instant_max</span> <span class="o">=</span> <span class="n">describe_size</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">DOWNLOAD_SPEED</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">slow_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_slow</span><span class="p">()])</span>
</span></span><span class="line"><span class="cl">        <span class="n">ok_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_ok</span><span class="p">()])</span>
</span></span><span class="line"><span class="cl">        <span class="n">instant_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_instant</span><span class="p">()])</span>
</span></span><span class="line"><span class="cl">        <span class="n">download_table</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;excessive&#34;</span><span class="p">,</span> <span class="s2">&#34;&gt; 10s&#34;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;&gt; </span><span class="si">{</span><span class="n">slow_max</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">excessive_count</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;slow&#34;</span><span class="p">,</span> <span class="s2">&#34;1s - 10s&#34;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">ok_max</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">slow_max</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">slow_count</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;ok&#34;</span><span class="p">,</span> <span class="s2">&#34;0.1s - 1s&#34;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">instant_max</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">ok_max</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">ok_count</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="s2">&#34;instant&#34;</span><span class="p">,</span> <span class="s2">&#34;≤ 0.1s&#34;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&#34;≤ </span><span class="si">{</span><span class="n">instant_max</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">instant_count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">download_table</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">summarize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">files</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">description</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">lines</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">description</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">file_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">total_bytes</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">total_size</span> <span class="o">=</span> <span class="n">describe_size</span><span class="p">(</span><span class="n">total_bytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">file_count</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> files (</span><span class="si">{</span><span class="n">total_size</span><span class="si">}</span><span class="s2">)&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">speed</span> <span class="o">=</span> <span class="n">describe_speed</span><span class="p">(</span><span class="n">DOWNLOAD_SPEED</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Download guesses for </span><span class="si">{</span><span class="n">speed</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">download_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_download_table</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">size_range</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">download_table</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">expression</span> <span class="o">=</span> <span class="n">DOWNLOAD_EXPRESSIONS</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="sa">f</span><span class="s2">&#34; </span><span class="si">{</span><span class="n">expression</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">description</span><span class="si">:</span><span class="s2"> &lt;10</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">size_range</span><span class="si">:</span><span class="s2"> &lt;26</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">count</span><span class="si">:</span><span class="s2"> &gt;6,</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">print_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;&#34;&#34;Format and display a summary of download estimates&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;---&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">full_summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summarize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                      <span class="sa">f</span><span class="s2">&#34;All files in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">public_dir</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">full_summary</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;---&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">media_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_media</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl">        <span class="n">media_summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summarize</span><span class="p">(</span><span class="n">media_files</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                       <span class="sa">f</span><span class="s2">&#34;Media files in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">public_dir</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">media_summary</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># ...</span></span></span></code></pre>
</figure><p>The script makes two download reports now, with only a little more work!</p>
<figure class="highlight">
  <pre tabindex="0"
    ><code class="language-" data-lang=""
      >$ python weight-with-media.py
---
All files in public
1,886 files (418.71 MB)
Download guesses for 750.00 Kbps
 🙁 &gt; 10s      &gt; 915.53 KB                   111
 😐 1s - 10s   91.55 KB - 915.53 KB          269
 😊 0.1s - 1s  9.16 KB - 91.55 KB            611
 😁 ≤ 0.1s     ≤ 9.16 KB                     895
---
Media files in public
802 files (392.19 MB)
Download guesses for 750.00 Kbps
 🙁 &gt; 10s      &gt; 915.53 KB                   107
 😐 1s - 10s   91.55 KB - 915.53 KB          236
 😊 0.1s - 1s  9.16 KB - 91.55 KB            339
 😁 ≤ 0.1s     ≤ 9.16 KB                     120</code></pre>
</figure><p>Yeah, that’s what I thought. The majority of those small files are text, and the vast majority of the large files are image or video. Yes, I noticed that a few of my excessively large files are text. Probably archive pages of one sort or another. I’ll gather the information on those later.</p>
<p>But it looks like I have an answer to my question.</p>
<h2 id="my-question">My question?</h2>
<p>Whether it’s worth my time to try optimizing image file sizes.</p>
<h2 id="oh-right-right-the-answer">Oh right right. The answer?</h2>
<p>The answer is &ldquo;yes.&rdquo;</p>
<p>Nearly half of my media files would be noticeably slow to download on a 3G connection. Over a hundred are large enough to stretch the patience of any visitor not blessed with a constant high speed pipe. That’s not very nice on my part.</p>
<p><em>Now</em> I know I can make it better. Even better: with this script, I can ask the question again whenever I want!</p>
<p>Optimizing images is another post, though.</p>
<h2 id="could-i-improve-my-weighing-script">Could I improve my weighing script?</h2>
<p>Of course! Here are some ideas I got while writing this, including a couple I included but removed to maintain focus.</p>
<ul>
<li>additional thresholds beyond &ldquo;excessive&rdquo; so I can determine how many files contribute to painfully long download times</li>
<li>verbose mode to list file details on request</li>
<li>options to estimate for different download rates</li>
<li>more detail on media files, perhaps to see if compression has been applied and how much</li>
<li>report base on page weight rather than individual fileweight, to get a more realistic idea of visitor experience.</li>
<li>format the list in JSON to simplify handing off to other reporting tools</li>
<li>include median and mean file sizes for more number crunching goodness</li>
<li>list the ten largest files, so I know where to focus my optimization efforts</li>
</ul>
<h3 id="should-i-optimize-my-weighing-script">Should I optimize my weighing script?</h3>
<p>Good question! Let’s look at the numbers.</p>
<figure class="highlight">
  <pre tabindex="0"
    ><code class="language-" data-lang=""
      >$ time make weight
python weight-with-media.py
...
real    0m0.131s
user    0m0.083s
sys     0m0.044s</code></pre>
</figure><p>No.</p>
<p>Seriously though. I assembled this in a few hours. Half of it’s too clever and the other half’s too stupid. But it gets the answers I need in a timely fashion. That&rsquo;s plenty good enough.</p>

  




  <section class="backlinks">
    <h2>Backlinks</h2>
    <nav>
      <ul>
      
      <li>
        <a href="/post/2019/08/proudly-doing-it-wrong/">proudly-doing-it-wrong</a>
      </li>
      
      <li>
        <a href="/post/2019/11/smug-mode-activated/">smug-mode-activated</a>
      </li>
      
      <li>
        <a href="/post/2019/11/summarizing-a-file-with-crystal/">summarizing-a-file-with-crystal</a>
      </li>
      
      <li>
        <a href="/post/2020/04/h-entry-microformat-for-indieweb-posts/">h-entry-microformat-for-indieweb-posts</a>
      </li>
      
      </ul>
    </nav>
  </section>



  <hr>
  

  
    <section>
      <p>
        Got a comment? A question? More of a comment than a question?
      </p>
      <p>
        Talk to me about this page on:
        
          
            <a
              href="https://hackers.town/@randomgeek/102199106551447993"
              class="u-syndication label centered fa fa-mastodon"
              title="Mastodon"
              rel="syndication"
              aria-label="Mastodon"
            >
              <span class="sr-only">mastodon</span>
            </a>
          
        
          
        
      </p>
    </section>
  
  
<hr>
<div class="footer">
    
    
      <a class="previous-post" href="https://randomgeekery.org/post/2019/05/kitty-terminal/?ref=footer">
        <span style="font-weight:bold;">« Previous</span>
        <br>Kitty Terminal
      </a>
    
    
      <div class="next-post">
        <a href="https://randomgeekery.org/post/2019/06/now-on-dreamhost/?ref=footer">
          <span style="font-weight:bold;">Next »</span>
          <br>Now on Dreamhost
        </a>
      </div>
    
</div>

  
</div>
            </main>
            
  
    <div class="article-toc ">
    <div class="toc-wrapper">
      <h4 id="contents"></h4>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#the-idea">The idea</a></li>
    <li><a href="#the-problem-with-my-idea">The problem with my idea</a></li>
    <li><a href="#what-numbers-should-i-care-about">What numbers <em>should</em> I care about?</a>
      <ul>
        <li><a href="#file-size">File size</a></li>
        <li><a href="#latency">Latency</a></li>
      </ul>
    </li>
    <li><a href="#measuring-file-sizes">Measuring file sizes</a></li>
    <li><a href="#estimating-download-time">Estimating download time</a>
      <ul>
        <li><a href="#picking-my-thresholds">Picking my thresholds</a></li>
      </ul>
    </li>
    <li><a href="#putting-it-all-together">Putting it all together</a>
      <ul>
        <li><a href="#all-the-files">All the files</a></li>
        <li><a href="#just-the-media-files">Just the media files</a></li>
      </ul>
    </li>
    <li><a href="#my-question">My question?</a></li>
    <li><a href="#oh-right-right-the-answer">Oh right right. The answer?</a></li>
    <li><a href="#could-i-improve-my-weighing-script">Could I improve my weighing script?</a>
      <ul>
        <li><a href="#should-i-optimize-my-weighing-script">Should I optimize my weighing script?</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

  

        </div><script defer data-domain="randomgeekery.org" src="https://plausible.io/js/script.js"></script>
    </body>
</html>

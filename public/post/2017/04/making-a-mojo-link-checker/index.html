<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
    










    







<script defer language="javascript" type="text/javascript" src="/js/bundle.min.60856f0f2ed73fb3cd2820ee548c4698ffbc4d743736e852c0e27ce4f52dfd9c.js"></script>






    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    
    <link rel="icon" href=/favicon.png>

    
    





  





  
  
  

<meta property="og:url" content="https://randomgeekery.org/post/2017/04/making-a-mojo-link-checker/">
<meta property="og:title" content="Making A Mojo Link Checker">
<meta name="twitter:title" content="Making A Mojo Link Checker">


  <meta name="twitter:site" content="@brianwisti">



  
    <meta name="twitter:description" content="I wrote a card/Perl script using utility features in Mojolicious to check all of the links in my site.
Nothing lasts forever. Sites get reorganized, move, or disappear. As my own site has gotten older — some of these pages are over fifteen years old — links from old posts stop working. link rot is a fact of life on the Internet. I want to minimize it here.
Instead of manually checking each of the 245 posts on this site, I chose to write some code that identifies the dead end links.">
    <meta property="og:description" content="I wrote a card/Perl script using utility features in Mojolicious to check all of the links in my site.
Nothing lasts forever. Sites get reorganized, move, or disappear. As my own site has gotten older — some of these pages are over fifteen years old — links from old posts stop working. link rot is a fact of life on the Internet. I want to minimize it here.
Instead of manually checking each of the 245 posts on this site, I chose to write some code that identifies the dead end links.">
  



<title itemprop="name">Making A Mojo Link Checker - Random Geekery</title>
<meta property="og:title" content=Making&#32;A&#32;Mojo&#32;Link&#32;Checker&#32;-&#32;Random&#32;Geekery />
<meta name="twitter:title" content=Making&#32;A&#32;Mojo&#32;Link&#32;Checker&#32;-&#32;Random&#32;Geekery />
<meta itemprop="name" content=Making&#32;A&#32;Mojo&#32;Link&#32;Checker&#32;-&#32;Random&#32;Geekery />
<meta name="application-name" content=Making&#32;A&#32;Mojo&#32;Link&#32;Checker&#32;-&#32;Random&#32;Geekery />
<meta property="og:site_name" content="Random Geekery" />


<meta name="description" content="" />
<meta itemprop="description" content="" />
<meta property="og:description" content="" />
<meta name="twitter:description" content="" />


<base href="https://randomgeekery.org/post/2017/04/making-a-mojo-link-checker/" />
<link rel="canonical" href="https://randomgeekery.org/post/2017/04/making-a-mojo-link-checker/" itemprop="url" />
<meta name="url" content="https://randomgeekery.org/post/2017/04/making-a-mojo-link-checker/" />
<meta name="twitter:url" content="https://randomgeekery.org/post/2017/04/making-a-mojo-link-checker/" />
<meta property="og:url" content="https://randomgeekery.org/post/2017/04/making-a-mojo-link-checker/" />


<meta property="og:updated_time" content=11004-11-12T40:00:17-0700 />


<link rel="sitemap" type="application/xml" title="Sitemap" href='https://randomgeekery.org/sitemap.xml' />

  <link
      rel="alternate"
      type="application/rss+xml"
    
        href="/index.xml"
    
      title="Random Geekery"/>



<meta name="robots" content="index,follow" />
<meta name="googlebot" content="index,follow" />


<meta name="twitter:site" content="" />
<meta name="twitter:creator" content="" />
<meta property="fb:admins" content="" />


<meta name="apple-mobile-web-app-title" content="Random Geekery" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />






<meta name="generator" content="Hugo 0.121.2">


    
    

<link
    rel="stylesheet"
    href="/css/style.fe9735814e6394fb590ff4fd2eb036a13152e6808ad90dd06ba181d89087b5d3.css"
    integrity="sha256-/pc1gU5jlPtZD/T9LrA2oTFS5oCK2Q3Qa6GB2JCHtdM=" 
    crossorigin="anonymous">


</head>

    <body class="">
        <div class="wrapper">
            <aside class="sidebar">
    <div class="container sidebar-sticky">
        <div class="light-dark" align="right">
    <button class="btn-light-dark" title="Toggle light/dark mode">
        <svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M6 .278a.768.768 0 0 1 .08.858a7.208 7.208 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277c.527 0 1.04-.055 1.533-.16a.787.787 0 0 1 .81.316a.733.733 0 0 1-.031.893A8.349 8.349 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71C0 4.266 2.114 1.312 5.124.06A.752.752 0 0 1 6 .278z"/>
        </svg>
        <svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16">
            <path fill="currentColor" d="M8 12a4 4 0 1 0 0-8a4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
        </svg>
    </button>
</div>

        <div class="sidebar-about">
    <h1 class="brand">
        
        
            <a href="https://randomgeekery.org">
                <h1>Random Geekery</h1>
            </a>
        
    </h1>
    <p class="lead">
    Collecting my attempts to improve at tech, art, and life
    </p>
</div>

        <nav>
    <ul class="sidebar-nav">
      
        <li class="bullet">
          <a href="/follow/">Follow</a>
        </li>
      
        <li class="bullet">
          <a href="/now/">Now</a>
        </li>
      
    </ul>
</nav>

        
  <div class="related">
    <div class="related-posts">
      <h3>Related</h3>
      <ul>
        
          <li><a href="/post/2017/02/converting-ogg-to-mp3/">Converting OGG To MP3</a></li>
        
          <li><a href="/post/2020/12/my-first-julia-script/">My first Julia script</a></li>
        
          <li><a href="/post/2020/05/letting-ruby-build-asciidoctor-files-for-hugo/">Letting Ruby build Asciidoctor files for Hugo</a></li>
        
          <li><a href="/post/2020/03/listing-hugo-content-extensions-with-raku/">Listing Hugo Content Extensions With Raku</a></li>
        
          <li><a href="/post/2020/01/go-back-to-bed/">Go back to bed</a></li>
        
      </ul>
    </div>
  </div>



        
















        <p class="footnote">
powered by <a target="_blank" href="https://gohugo.io">Hugo</a> | themed with <a target="_blank" href="https://github.com/lukeorth/poison">poison</a>
    <br>
    &copy; 2024 Brian Wisti. All rights reserved.
</p>
<p class="footnote">
  This work is licensed under a
  <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
    Creative Commons Attribution 4.0 International License
  </a>.
</p>

  </div>
</aside>

            <main class="content container">
                <div class="post">
  <nav class="masthead">
    <ul>
    
  
    
  
    
  
    
  

    <li><a href="https://randomgeekery.org/">Random Geekery</a></li>
  

    <li><a href="https://randomgeekery.org/post/">Posts</a></li>
  

    <li><a href="https://randomgeekery.org/post/2017/">2017</a></li>
  

    <li><a class="active" href="https://randomgeekery.org/post/2017/04/making-a-mojo-link-checker/">Making A Mojo Link Checker</a></li>
</nav>



  <div class="info">
    <h1 class="post-title">
        <a href="https://randomgeekery.org/post/2017/04/making-a-mojo-link-checker/">Making A Mojo Link Checker</a>
    </h1>
    
        <time datetime="2017-04-11T00:00:00-0700" class="post-date">
            April 11, 2017
        </time>
    
    
    <ul class="tags">
        
        <li class="tag-perl">
            <a href="https://randomgeekery.org/tags/perl">perl</a>
        </li>
        
        <li class="tag-site">
            <a href="https://randomgeekery.org/tags/site">site</a>
        </li>
        
        <li class="tag-mojolicious">
            <a href="https://randomgeekery.org/tags/mojolicious">mojolicious</a>
        </li>
        
        <li class="tag-programming">
            <a href="https://randomgeekery.org/tags/programming">programming</a>
        </li>
        
    </ul>
    
    
    
    
    
    
</div>

  <p>I wrote a <a href="/card/perl/">card/Perl</a> script using utility features in Mojolicious to check all of the links in my site.</p>
<p>Nothing lasts forever. Sites get reorganized, move, or disappear. As my own site has gotten older — some of these pages are over fifteen years old — links from old posts stop working. <a href="https://en.wikipedia.org/wiki/Link_rot">link rot</a> is a fact of life on the Internet. I want to minimize it here.</p>
<p>Instead of manually checking each of the 245 posts on this site, I chose to write some code that identifies the dead end links. Then I could manually adjust the bad links. Yay! That’s hand-crafted automation there.</p>
<h2 id="use-mojo">use Mojo!</h2>
<p><a href="/card/mojolicious/">card/Mojolicious</a> is a Perl framework for making Web applications. It also happens to provide <a href="http://mojolicious.org/perldoc#REFERENCE">excellent support</a> for a wide range of Web-related programming.</p>
<p>I mentioned Mojolicious here before. I use it as a part of my daily dev toolkit, even though I <em>still</em> haven’t made a real Web app with it.</p>
<h2 id="the-code">The code</h2>
<p>I could just dump the script here and go on with my day, but I feel like typing a lot for some reason. Let’s go through the major chunks of the code.</p>
<h3 id="the-setup">The setup</h3>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">use</span> <span class="mf">5.24.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">warnings</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">experimental</span> <span class="s">&#39;signatures&#39;</span><span class="p">;</span></span></span></code></pre>
</figure><p>Whenever possible, I specify the latest version of Perl (currently <a href="http://perldoc.perl.org/perl5240delta.html">5.24</a>. It enables some features and deprecates others. If nothing else, it reminds me when I last worked on the code. Recent Perl versions automatically enable <a href="http://perldoc.perl.org/strict.html"><code>strict</code></a>, but it’s useful for me to also turn on <a href="http://perldoc.perl.org/warnings.html"><code>warnings</code></a>.</p>
<p>The <a href="https://metacpan.org/pod/experimental"><code>experimental</code></a> CPAN module saves some boiler plate when using Perl features that have not fully stabilized — such as function <a href="http://perldoc.perl.org/feature.html#The-%27signatures%27-feature">signatures</a>.</p>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">Mojo::DOM</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">Mojo::File</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">Mojo::JSON</span> <span class="sx">qw(decode_json)</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">Mojo::URL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">use</span> <span class="nn">Mojo::UserAgent</span><span class="p">;</span></span></span></code></pre>
</figure><p>Mojolicious provides a remarkable amount of functionality for such a small installation. This is just what I’m explicitly using.</p>
<dl>
<dt><a href="http://mojolicious.org/perldoc/Mojo/DOM">Mojo::DOM</a></dt>
<dd>HTML/XML DOM parser that supports <a href="https://www.w3.org/TR/CSS2/selector.html">CSS Selectors</a></dd>
<dt><a href="http://mojolicious.org/perldoc/Mojo/File">Mojo::File</a></dt>
<dd>for handling filepaths and easy reading / writing files.</dd>
<dt><a href="http://mojolicious.org/perldoc/Mojo/JSON">Mojo::JSON</a></dt>
<dd><code>decode_json</code> lets me turn the <a href="http://gohugo.io/">Hugo</a> <code>config.json</code> file into a Perl structure.</dd>
<dt><a href="http://mojolicious.org/perldoc/Mojo/URL">Mojo::URL</a></dt>
<dd>understands the components of Uniform Resource Locators</dd>
<dt><a href="http://mojolicious.org/perldoc/Mojo/UserAgent">Mojo::UserAgent</a></dt>
<dd>makes HTTP and WebSocket requests (similar to <a href="https://metacpan.org/pod/LWP::UserAgent">LWP::UserAgent</a>, or <a href="http://docs.python-requests.org/en/master/">Requests</a> for Python people)</dd>
</dl>
<h3 id="from-the-top">From the top</h3>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$config_file</span>   <span class="o">=</span> <span class="s">&#34;config.json&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$config</span>        <span class="o">=</span> <span class="n">decode_json</span><span class="p">(</span><span class="nn">Mojo::File</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="nv">$config_file</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">slurp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$site</span>          <span class="o">=</span> <span class="nn">Mojo::URL</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span><span class="nv">$config</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">BaseURL</span><span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$root</span>          <span class="o">=</span> <span class="nv">$config</span><span class="o">-&gt;</span><span class="p">{</span><span class="n">publishDir</span><span class="p">}</span> <span class="o">||</span> <span class="s">&#39;public&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$checked_links</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$ua</span>            <span class="o">=</span> <span class="nn">Mojo::UserAgent</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nv">$ua</span><span class="o">-&gt;</span><span class="n">max_redirects</span><span class="p">(</span> <span class="mi">5</span> <span class="p">);</span> <span class="c1"># some sites love lots of redirects</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">my</span> <span class="nv">$test_file</span> <span class="o">=</span> <span class="nb">shift</span> <span class="nv">@ARGV</span> <span class="sr">//</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span> <span class="nv">$test_file</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">check_links_in</span><span class="p">(</span> <span class="nv">$test_file</span><span class="p">,</span> <span class="nv">$ua</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">my</span> <span class="nv">$path</span> <span class="o">=</span> <span class="nn">Mojo::File</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="nv">$root</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">my</span> <span class="nv">$files</span> <span class="o">=</span> <span class="nv">$path</span><span class="o">-&gt;</span><span class="nn">list_tree</span><span class="o">-&gt;</span><span class="nb">grep</span><span class="p">(</span> <span class="sx">qr{ \. (?:html|xml )$ }</span><span class="n">x</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nv">$files</span><span class="o">-&gt;</span><span class="nb">each</span><span class="p">(</span> <span class="k">sub</span> <span class="p">{</span> <span class="n">check_links_in</span><span class="p">(</span><span class="nv">$_</span><span class="p">);</span> <span class="p">}</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre>
</figure><p>This is the important bit: load the config, create a user agent, and check links in one or all of the generated HTML files. I checked the generated HTML files in <code>public</code> because I didn’t feel like messing with <code>hugo server</code> or a Mojolicious mini-app. Scraping a local server could be an option later.</p>
<p>Using Mojolicious for everything was so much fun that I rewrote <code>config.yaml</code> as <code>config.json</code> to allow using <code>Mojo::JSON</code> here. Hugo’s built-in support for different <a href="http://gohugo.io/overview/configuration/">configuration format</a> made that a painless shift. Then Mojo lets me <a href="http://mojolicious.org/perldoc/Mojo/File#slurp"><code>slurp</code></a> the contents of the config file into a single string, which <a href="http://mojolicious.org/perldoc/Mojo/JSON#decode_json"><code>decode_json</code></a> turns into a hash reference.</p>
<p><a href="http://mojolicious.org/perldoc/Mojo/File#list_tree"><code>list_tree</code></a> gives a recursive directory listing of everything under <code>$root</code> as a <a href="http://mojolicious.org/perldoc/Mojo/Collection">Mojo::Collection</a>. Collections provide a tidy toolkit of list handling functionality without requiring me to go back and forth between arrays and array references.
I could find and iterate over all the HTML and XML files in vanilla Perl 5, but I like this better.</p>
<p>After a few runs, I added the ability to specify a single file in <a href="http://perldoc.perl.org/perlvar.html#%40ARGV"><code>@ARGV</code></a>. That way I can figure things out when that one link in that one file causes trouble.</p>
<h3 id="checking-links-in-a-file">Checking links in a file</h3>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">check_links_in</span><span class="p">($filename) {</span>
</span></span><span class="line"><span class="cl">  <span class="k">my</span> <span class="nv">$html</span> <span class="o">=</span> <span class="nn">Mojo::File</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="nv">$filename</span> <span class="p">)</span><span class="o">-&gt;</span><span class="n">slurp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">my</span> <span class="nv">$dom</span> <span class="o">=</span> <span class="nn">Mojo::DOM</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="nv">$html</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">my</span> <span class="nv">$links</span> <span class="o">=</span> <span class="nv">$dom</span><span class="o">-&gt;</span><span class="n">find</span><span class="p">(</span> <span class="s">&#39;[href], [src]&#39;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nv">$links</span><span class="o">-&gt;</span><span class="nb">each</span><span class="p">(</span> <span class="n">sub</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$n</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$target</span> <span class="o">=</span> <span class="nv">$link</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">(</span> <span class="s">&#34;href&#34;</span> <span class="p">)</span> <span class="o">||</span> <span class="nv">$link</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">(</span> <span class="s">&#34;src&#34;</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Assume status will not change during the same run.</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">if</span> <span class="nb">exists</span> <span class="nv">$checked_links</span><span class="o">-&gt;</span><span class="p">{</span> <span class="nv">$target</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$checked_links</span><span class="o">-&gt;</span><span class="p">{</span> <span class="nv">$target</span> <span class="p">}</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">my</span> <span class="nv">$url</span> <span class="o">=</span> <span class="nn">Mojo::URL</span><span class="o">-&gt;</span><span class="k">new</span><span class="p">(</span> <span class="nv">$target</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Ignore email links</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">if</span> <span class="nv">$url</span><span class="o">-&gt;</span><span class="n">scheme</span> <span class="o">&amp;&amp;</span> <span class="nv">$url</span><span class="o">-&gt;</span><span class="n">scheme</span> <span class="ow">eq</span> <span class="s">&#39;mailto&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nv">$checked_links</span><span class="o">-&gt;</span><span class="p">{</span> <span class="nv">$target</span> <span class="p">}</span> <span class="o">=</span> <span class="n">file_exists_for</span><span class="p">(</span> <span class="nv">$url</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="sr">//</span> <span class="n">external_link_works_for</span><span class="p">(</span> <span class="nv">$url</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="sr">//</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># In this version we only care about invalid links.</span>
</span></span><span class="line"><span class="cl">    <span class="k">unless</span> <span class="p">(</span> <span class="nv">$checked_links</span><span class="o">-&gt;</span><span class="p">{</span> <span class="nv">$target</span> <span class="p">}</span> <span class="p">)</span> <span class="p">{</span> <span class="n">say</span> <span class="n">summary_for</span><span class="p">(</span> <span class="nv">$target</span><span class="p">,</span> <span class="nv">$filename</span> <span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre>
</figure><p>Once again I <code>slurp</code> a file into a string. This time it gets handed off to <code>Mojo::DOM</code> so it can <a href="http://mojolicious.org/perldoc/Mojo/DOM#find"><code>find</code></a> any elements with <code>src</code> or <code>href</code> attributes, and then create a <code>Mojo::URL</code> from the appropriate <a href="http://mojolicious.org/perldoc/Mojo/DOM#attr"><code>attr</code></a>. <code>Mojo::URL</code> does the tedious work of parsing URLs and making components like <a href="http://mojolicious.org/perldoc/Mojo/URL#scheme"><code>scheme</code></a> available.</p>
<p>Leaning on the <code>//</code> defined-or logical shortcut lets me take advantage of the three boolean states of Perl: truthy, falsey, and &ldquo;I dunno.&rdquo; Each URL-testing subroutine can return <code>undef</code> to indicate that it doesn’t know what to do with the URL, and let the next subroutine in line handle it. If nobody knows what to do with it, then that’s a bad link and gets remembered as a falsey value.</p>
<p><a href="http://mojolicious.org/perldoc/Mojo/Collection#each"><code>each</code></a> hands two items to the subroutine it invokes: an item in the collection and what number in the collection that item is (starting from 1). No, I don’t use <code>$n</code>, but I wanted you to see that it’s available. You can also access the item as <code>$_</code> as I did earlier. You can even do your subroutine arguments the old fashioned way with <code>@_</code>.</p>
<h3 id="is-it-an-internal-link">Is it an internal link?</h3>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">file_exists_for</span><span class="p">($url) {</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># Ignore full urls that aren&#39;t pointed at my site.</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="nv">$url</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">&amp;&amp;</span> <span class="nv">$url</span><span class="o">-&gt;</span><span class="n">host</span> <span class="ow">ne</span> <span class="nv">$site</span><span class="o">-&gt;</span><span class="n">host</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="nv">$url</span><span class="o">-&gt;</span><span class="n">fragment</span> <span class="o">&amp;&amp;</span> <span class="nv">$url</span><span class="o">-&gt;</span><span class="n">path</span> <span class="ow">eq</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Points to a URL fragment within itself</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Today I don&#39;t care about those.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># If I did, I&#39;d remember what file $url came from, load it, and check the DOM.</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">my</span> <span class="nv">$path</span> <span class="o">=</span> <span class="nv">$url</span><span class="o">-&gt;</span><span class="n">path</span>
</span></span><span class="line"><span class="cl">    <span class="ow">or</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="nv">$path</span> <span class="ow">eq</span> <span class="s">&#39;/&#39;</span> <span class="o">||</span> <span class="nv">$path</span><span class="o">-&gt;</span><span class="n">trailing_slash</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$path</span> <span class="o">=</span> <span class="nv">$path</span><span class="o">-&gt;</span><span class="n">merge</span><span class="p">(</span><span class="s">&#34;index.html&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">my</span> <span class="nv">$file</span> <span class="o">=</span> <span class="nv">$root</span> <span class="o">.</span> <span class="nv">$path</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="o">-</span><span class="n">f</span> <span class="nv">$file</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre>
</figure><p>I would check for <code>../</code> abuse if this was a general purpose script, but it’s mostly links I added by hand and checked manually at some point in the last fifteen years. So - assuming past me was not acting maliciously or foolishly, we rule out more likely situations:</p>
<ul>
<li>The URL <a href="http://mojolicious.org/perldoc/Mojo/URL#host"><code>host</code></a> points to something besides my site, which means it can’t be a local file.</li>
<li>The link has a <a href="http://mojolicious.org/perldoc/Mojo/URL#fragment"><code>fragment</code></a> pointing to a named anchor and nothing else. I only have that on <a href="/post/2014/10/blog-writing-in-org-mode/">one page</a> right now, and I don’t feel like complicating this script for a single page.</li>
<li>The <a href="http://mojolicious.org/perldoc/Mojo/URL#path"><code>path</code></a> isn’t set, which at this point means an empty link. That can’t be good.</li>
<li>If the link <em>is</em> to a local file, we check whether it exists.</li>
</ul>
<p><a href="http://mojolicious.org/perldoc/Mojo/Path">Mojo::Path</a> manipulation delights me. Sure, this could be a regular expression substitution with fewer characters of code, but someone else seeing <a href="http://mojolicious.org/perldoc/Mojo/Path#merge"><code>merge</code></a> after a check for a <a href="http://mojolicious.org/perldoc/Mojo/Path#trailing_slash">trailing slash</a> would probably understand that I’m adjusting for the common practice of <code>/thing/</code> being a link to <code>/thing/index.html</code>. They might understand even if they weren’t Perl developers!</p>
<h3 id="is-it-a-working-external-link">Is it a working external link?</h3>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">external_link_works_for</span><span class="p">($url, $ua) {</span>
</span></span><span class="line"><span class="cl">  <span class="k">my</span> <span class="nv">$response</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># Ignore tutorial demo links</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nv">$url</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">&amp;&amp;</span> <span class="nv">$url</span><span class="o">-&gt;</span><span class="n">host</span> <span class="ow">eq</span> <span class="s">&#39;localhost&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># Ex: //www.youtube.com/embed/bWqSuBg8AMo</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># Produced by some Hugo shortcodes.</span>
</span></span><span class="line"><span class="cl">  <span class="k">my</span> <span class="nv">$is_protocol_relative</span> <span class="o">=</span> <span class="o">!</span><span class="nv">$url</span><span class="o">-&gt;</span><span class="n">scheme</span> <span class="o">&amp;&amp;</span> <span class="nv">$url</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">&amp;&amp;</span> <span class="nv">$url</span><span class="o">-&gt;</span><span class="n">host</span> <span class="ow">ne</span> <span class="nv">$site</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="nv">$is_protocol_relative</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Use my site&#39;s choice of HTTP / HTTPS</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$url</span><span class="o">-&gt;</span><span class="n">scheme</span><span class="p">(</span> <span class="nv">$site</span><span class="o">-&gt;</span><span class="n">scheme</span> <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nb">eval</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">$response</span> <span class="o">=</span> <span class="nv">$ua</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">(</span> <span class="nv">$url</span> <span class="p">)</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="vg">$@</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">warn</span> <span class="s">&#34;When checking $url: $@&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nv">$response</span><span class="o">-&gt;</span><span class="n">is_success</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre>
</figure><p>After some quick checks to ensure I’m not looking at a blog demo link and that I handle <a href="https://www.paulirish.com/2010/the-protocol-relative-url/">protocol-relative URLs</a> correctly, I wrap a simple <a href="http://mojolicious.org/perldoc/Mojo/UserAgent#head"><code>head</code></a> request in an <code>eval</code> block.</p>
<p>I use <a href="https://ochronus.com/http-head-request-good-uses/"><code>HTTP HEAD</code></a> because I only care about whether the link is valid. I don’t want the full content at the link. <code>eval</code> lets me catch timeouts and requests being sent to Web sites which no longer exist. Assuming no errors, this eventually returns whether the <a href="http://mojolicious.org/perldoc/Mojo/Transaction#result"><code>result</code></a> of the <a href="http://mojolicious.org/perldoc/Mojo/Transaction/HTTP">HTTP transaction</a> succeeded with <a href="http://mojolicious.org/perldoc/Mojo/Message/Response#is_success"><code>is_success</code></a>.</p>
<h3 id="summarize-it">Summarize it</h3>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-perl" data-lang="perl"><span class="line"><span class="cl"><span class="k">sub</span> <span class="nf">summary_for</span><span class="p">($target, $filename) {</span>
</span></span><span class="line"><span class="cl">  <span class="nb">die</span> <span class="s">&#34;Didn&#39;t check [$target]?&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">unless</span> <span class="nb">exists</span> <span class="nv">$checked_links</span><span class="o">-&gt;</span><span class="p">{</span> <span class="nv">$target</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">my</span> <span class="nv">$status</span> <span class="o">=</span> <span class="nv">$checked_links</span><span class="o">-&gt;</span><span class="p">{</span> <span class="nv">$target</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">?</span> <span class="s">&#34;+&#34;</span>  <span class="c1"># It worked!</span>
</span></span><span class="line"><span class="cl">    <span class="p">:</span> <span class="s">&#34;-&#34;</span>  <span class="c1"># Something went wrong.</span>
</span></span><span class="line"><span class="cl">    <span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="s">&#34;$status $filename $target&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre>
</figure><p>Today I only looked for bad links, but it can be useful to know the status of <em>all</em> links in my site. I used it a few times during development. May as well leave that bit of logic in.</p>
<h2 id="whats-that-do">What’s That Do?</h2>
<figure class="highlight">
  <pre tabindex="0"
    ><code class="language-" data-lang=""
      >$ ./scripts/link-checker &gt; links.txt</code></pre>
</figure><p>A couple hundred lines like this, basically.</p>
<figure class="highlight">
  <pre tabindex="0"
    ><code class="language-" data-lang=""
      >When checking http://coolnamehere.com: Premature connection close at scripts/check-links.pl line 53.
- public/categories/blogspot/index.html http://coolnamehere.com
- public/categories/blogspot/index.html http://blogspot.com
When checking http://vim.org/: Can&#39;t connect: Name or service not known at scripts/check-links.pl line 53.
- public/categories/blogspot/index.html http://vim.org/
When checking http://jruby.codehaus.org: Connect timeout at scripts/check-links.pl line 53.
- public/categories/blogspot/index.html http://jruby.codehaus.org
- public/categories/blogspot/index.html http://devzone.zend.com/article/2262-Zend-Framework-1.0.0-production-release
When checking http://jruby.codehaus.org/: Connect timeout at scripts/check-links.pl line 53.
- public/categories/coolnamehere/index.html http://jruby.codehaus.org/</code></pre>
</figure><p>Goodness those are embarrassing.</p>
<p>Okay I’m gonna go fix this.</p>
<p>Some links just won’t work with this code. I may revisit this later, but I got what I need. All links should at least work in a browser for now.</p>
<p>An added bonus that I didn’t expect: this code also ran on Windows 10 with no  changes needed.</p>
<h2 id="more-ideas">More Ideas</h2>
<p>Improvements that I thought of while putting this together, which I may eventually try out.</p>
<ul>
<li>Be a good bot citizen by paying attention to <a href="http://www.robotstxt.org/robotstxt.html"><code>robots.txt</code></a>. I tried that in an early version of the script, but hardly any of the sites provided one. I’ll ponder and try not to run the script too often for now.</li>
<li>Wrap things up in a <a href="http://mojolicious.org/perldoc/Mojo/Base">Mojo::Base</a> class for organization.</li>
<li>Run an instance and scrape that live - see if it makes a difference!</li>
<li>Use non-blocking requests, since <a href="http://mojolicious.org/perldoc/Mojo/UserAgent">Mojo::UserAgent</a> supports them.</li>
<li>Cache results to disk, since working links tend to stay that way for <em>at least</em> a few days.</li>
<li>Find out why some URLs didn’t work. Was it a <code>robots.txt</code> thing? A weird redirect? They worked in the browser, after all.</li>
</ul>
<p>Honestly the script does what I need it to, and I might never implement these other ideas.</p>

  




  <section class="backlinks">
    <h2>Backlinks</h2>
    <nav>
      <ul>
      
      <li>
        <a href="/post/2020/02/stealing-a-hugo-shortcode-for-nikola/">stealing-a-hugo-shortcode-for-nikola</a>
      </li>
      
      </ul>
    </nav>
  </section>



  <hr>
  

  
    <section>
      <p>
        Got a comment? A question? More of a comment than a question?
      </p>
      <p>
        Talk to me about this page on:
        
          
        
      </p>
    </section>
  
  
<hr>
<div class="footer">
    
    
      <a class="previous-post" href="https://randomgeekery.org/post/2017/03/geekish-update/?ref=footer">
        <span style="font-weight:bold;">« Previous</span>
        <br>Geekish Update
      </a>
    
    
      <div class="next-post">
        <a href="https://randomgeekery.org/post/2017/04/kaleidoscope-symmetry/?ref=footer">
          <span style="font-weight:bold;">Next »</span>
          <br>Kaleidoscope Symmetry
        </a>
      </div>
    
</div>

  
</div>
            </main>
            
  
    <div class="article-toc ">
    <div class="toc-wrapper">
      <h4 id="contents"></h4>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#use-mojo">use Mojo!</a></li>
    <li><a href="#the-code">The code</a>
      <ul>
        <li><a href="#the-setup">The setup</a></li>
        <li><a href="#from-the-top">From the top</a></li>
        <li><a href="#checking-links-in-a-file">Checking links in a file</a></li>
        <li><a href="#is-it-an-internal-link">Is it an internal link?</a></li>
        <li><a href="#is-it-a-working-external-link">Is it a working external link?</a></li>
        <li><a href="#summarize-it">Summarize it</a></li>
      </ul>
    </li>
    <li><a href="#whats-that-do">What’s That Do?</a></li>
    <li><a href="#more-ideas">More Ideas</a></li>
  </ul>
</nav>
    </div>
</div>

  

        </div><script defer data-domain="randomgeekery.org" src="https://plausible.io/js/script.js"></script>
    </body>
</html>

<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0"
  xmlns:atom="http://www.w3.org/2005/Atom"
  xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>fixing my webmentionsonRandom Geekery</title>
    <link>https://randomgeekery.org/series/fixing-my-webmentions/</link>
    <description>
      Recent contentinfixing my webmentions on Random Geekery
    </description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
      
      <lastBuildDate>Tue, 10 Nov 2020 00:00:00 -0800</lastBuildDate><atom:link href="https://randomgeekery.org/series/fixing-my-webmentions/index.xml" rel="self" type="application/rss+xml" /><item>
  <title>Post: Using the Webmention.io API</title>
  <link>https://randomgeekery.org/post/2020/11/using-the-webmentionio-api/</link>
  <pubDate>Tue, 10 Nov 2020 00:00:00 -0800</pubDate>
  
  <guid>https://randomgeekery.org/post/2020/11/using-the-webmentionio-api/</guid>
  <description>A spiderweb! For inbox/Webmention! Get it? Okay, yeah. Sorry.
So I hosed a local copy of my mentions feed the other month. What’s my “mentions feed,” I hear you wondering?
Whenever somebody shares a reaction to something here — like, reshare, reply, mention — that reaction gets sent to Webmention.io. There are more moving parts than that, of course. Bridgy aggregates reactions to my announcement toots and tweets and sends those to Webmention.</description>
   <category>post</category> 
   <category>post</category> 
   <category>python</category>  <category>indieweb</category>  <category>fixingmysite</category>  <category>site</category>  <category>tools</category> 
  <content:encoded><![CDATA[<h2>Fetching my IndieWeb mentions with HTTPie and Requests</h2><p><img src="/post/2020/11/../../../attachments/img/2020/cover-2020-11-10.jpg" alt="attachments/img/2020/cover-2020-11-10.jpg"/>
A spiderweb! For <em>inbox/Webmention</em>! Get it? Okay, yeah. Sorry.</p>
<p>So I hosed a local copy of my mentions feed the other month.  What’s my &ldquo;mentions feed,&rdquo; I hear you wondering?</p>
<p>Whenever somebody shares a reaction to something here — like, reshare, reply, mention — that reaction gets sent to <a href="https://webmention.io">Webmention.io</a>.  There are more moving parts than that, of course.  <a href="https://brid.gy">Bridgy</a> aggregates reactions to my announcement toots and tweets and sends those to Webmention.  It shows in my mentions feed as a reaction to site content when someone reacts to a relevant tweet.</p>
<p><em>Sometimes</em> folks even post mentions, replies, and reactions directly to the Webmention endpoint.  Mostly it’s just social media reactions, though.</p>
<p>The Webmention.io <a href="https://github.com/aaronpk/webmention.io#api">API</a> lets me gather all of these reactions.</p>
<p>Let’s acquaint ourselves with the important parts of this API.  You’ll need your API token, which can be found in the Webmention <a href="https://webmention.io/settings">settings</a> once you sign up.</p>
<h2 id="reading-the-feed-with-httpie">Reading the feed with HTTPie</h2>
<p>I’ll use <a href="https://httpie.io">HTTPie</a> for my little exploration.  I like the way it works.</p>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">pip install httpie</span></span></code></pre>
</figure><h3 id="getting-recent-reactions">Getting recent reactions</h3>
<p>We mainly care about the mentions endpoint.  Hand it your domain and API token, and it will send you the 20 most recent responses for your site.</p>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">http get https://webmention.io/api/mentions.jf2 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="nv">domain</span><span class="o">==</span>randomgeekery.org <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="nv">token</span><span class="o">==</span><span class="nv">$WEBMENTION_KEY</span></span></span></code></pre>
</figure><p>HTTPie’s double-equals <code>==</code> syntax means &ldquo;make a query string,&rdquo; so I end up with something like this::</p>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-text" data-lang="text"><span class="line"><span class="cl">https://webmention.io/api/mentions.jf2?domain=randomgeekery.org&amp;token=xxxxx</span></span></code></pre>
</figure><p>When <code>http</code> fetches that URL, I get back a <a href="https://www.w3.org/TR/jf2/">JF2</a> feed that looks something like this.</p>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;children&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;author&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Jumpei KAWAMI&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;photo&#34;</span><span class="p">:</span> <span class="s2">&#34;https://webmention.io/avatar/…&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;card&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;url&#34;</span><span class="p">:</span> <span class="s2">&#34;https://twitter.com/junkw&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;text&#34;</span><span class="p">:</span> <span class="s2">&#34;I wrote a note:\n\nI added this note from org mode…&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;published&#34;</span><span class="p">:</span> <span class="s2">&#34;2020-10-25T23:32:25+00:00&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;repost-of&#34;</span><span class="p">:</span> <span class="s2">&#34;https://randomgeekery.org/note/2020/10/i-added-this-note-from-org-mode/&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;entry&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;url&#34;</span><span class="p">:</span> <span class="s2">&#34;https://twitter.com/junkw/status/1320508544601509889&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;wm-id&#34;</span><span class="p">:</span> <span class="mi">887739</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;wm-private&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;wm-property&#34;</span><span class="p">:</span> <span class="s2">&#34;repost-of&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;wm-received&#34;</span><span class="p">:</span> <span class="s2">&#34;2020-10-26T04:07:20Z&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;wm-source&#34;</span><span class="p">:</span> <span class="s2">&#34;https://brid-gy.appspot.com/repost/twitter/brianwisti/…&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;wm-target&#34;</span><span class="p">:</span> <span class="s2">&#34;https://randomgeekery.org/note/2020/10/i-added-this-note-from-org-mode/&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="err">⋮</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Webmentions&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;feed&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre>
</figure><p>What’s JF2?  It’s obviously JSON.  Maybe something to do with <a href="https://jsonfeed.org/">JSON Feed</a>?  Similar, but no.  JF2 is a JSON format for <a href="/card/microformats/">microformats2</a>.  The mnemonic I’ve been trying to drill into my head is &ldquo;JSON (micro)Formats 2.&rdquo;</p>
<p>It’s not a very good mnemonic.</p>
<p>Each entry summarizes the reaction, including which of my posts they were reacting to.  That’s kind of important.  Most recently, Twitter user <a href="https://twitter.com/junkw">@junkw</a> retweeted my announcement about <a href="/post/2020/10/i-added-this-note-from-org-mode/">adding a note from Org mode</a>.</p>
<blockquote>
<p><strong>NOTE</strong></p>
<p>There’s also a <code>.json</code> endpoint for every feed that presents a different structure for mentions.  I prefer it, because it contains fewer <code>wm-*</code> fields.  But the documentation uses JF2, so that’s what I’ll do.</p>
</blockquote>
<h3 id="checking-for-new-reactions">Checking for new reactions</h3>
<p>Maybe I’m checking again later and only want to see the <em>new</em> reactions.  I request mentions received since the value of the <code>wm-received</code> field in the last entry I have.</p>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">http get https://webmention.io/api/mentions.jf2 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="nv">domain</span><span class="o">==</span>randomgeekery.org <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="nv">token</span><span class="o">==</span><span class="nv">$WEBMENTION_KEY</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="nv">since</span><span class="o">==</span><span class="s2">&#34;2020-10-26T04:07:20Z&#34;</span></span></span></code></pre>
</figure><figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;children&#34;</span><span class="p">:</span> <span class="p">[],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Webmentions&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;feed&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre>
</figure><p>Well, yeah.  That makes sense.  I don’t get the kind of traffic where you’d expect fresh reactions every time you check.</p>
<h3 id="fetching-the-oldest-reactions-first">Fetching the oldest reactions first</h3>
<p>As I mentioned at the start, my site is a little broken.  I need to rebuild the full list of reactions so my <a href="/card/hugo/">card/Hugo</a> site can work with a complete record. To do that, I should probably start from the oldest mentions and work my way forward.</p>
<p>Rather than the default <code>sort-dir</code> of <code>down</code>, I specify <code>up</code>.</p>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">http get https://webmention.io/api/mentions.jf2 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="nv">domain</span><span class="o">==</span>randomgeekery.org <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="nv">token</span><span class="o">==</span><span class="nv">$WEBMENTION_KEY</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  sort-dir<span class="o">==</span>up</span></span></code></pre>
</figure><figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;children&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;author&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Steve Scaffidi&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;photo&#34;</span><span class="p">:</span> <span class="s2">&#34;https://webmention.io/avatar/…&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;card&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;url&#34;</span><span class="p">:</span> <span class="s2">&#34;https://twitter.com/hercynium&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;html&#34;</span><span class="p">:</span> <span class="s2">&#34;This is where I wish Perl5 had something like Python&#39;s AST class hierarchy…&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;text&#34;</span><span class="p">:</span> <span class="s2">&#34;This is where I wish Perl5 had something like Python&#39;s AST class hierarchy…&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;in-reply-to&#34;</span><span class="p">:</span> <span class="s2">&#34;https://randomgeekery.org/2020/02/17/python-invoke/&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;published&#34;</span><span class="p">:</span> <span class="s2">&#34;2020-02-18T03:11:58+00:00&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;entry&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;url&#34;</span><span class="p">:</span> <span class="s2">&#34;https://twitter.com/hercynium/status/1229604443651526656&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;wm-id&#34;</span><span class="p">:</span> <span class="mi">757935</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;wm-private&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;wm-property&#34;</span><span class="p">:</span> <span class="s2">&#34;in-reply-to&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;wm-received&#34;</span><span class="p">:</span> <span class="s2">&#34;2020-02-18T22:32:20Z&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;wm-source&#34;</span><span class="p">:</span> <span class="s2">&#34;https://brid-gy.appspot.com/comment/twitter/brianwisti/…&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;wm-target&#34;</span><span class="p">:</span> <span class="s2">&#34;https://randomgeekery.org/2020/02/17/python-invoke/&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Webmentions&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;feed&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre>
</figure><p>Aww, my first site reply. From <a href="https://twitter.com/hercynium">@hercynium</a>.</p>
<p>I only get 20 results by default, though.  Here.  Let’s make <a href="https://stedolan.github.io/jq/">jq</a> show us. Here’s a default page.</p>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">http get https://webmention.io/api/mentions.jf2 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="nv">domain</span><span class="o">==</span>randomgeekery.org <span class="nv">token</span><span class="o">==</span><span class="nv">$WEBMENTION_KEY</span> sort-dir<span class="o">==</span>up <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="p">|</span> jq <span class="s1">&#39;.children | length&#39;</span></span></span></code></pre>
</figure><figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-text" data-lang="text"><span class="line"><span class="cl">20</span></span></code></pre>
</figure><h3 id="handling-result-pagination">Handling result pagination</h3>
<p>I can specify how many responses I want in each response with the <code>per-page</code> parameter.  With <code>per-page</code> set to 100, I get a hundred entries.</p>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">http get https://webmention.io/api/mentions.jf2 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="nv">domain</span><span class="o">==</span>randomgeekery.org <span class="nv">token</span><span class="o">==</span><span class="nv">$WEBMENTION_KEY</span> per-page<span class="o">==</span><span class="m">100</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="p">|</span> jq <span class="s1">&#39;.children | length&#39;</span></span></span></code></pre>
</figure><figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-text" data-lang="text"><span class="line"><span class="cl">100</span></span></code></pre>
</figure><p>Of course, if there aren’t a hundred entries to fill the page, I only get what’s available.</p>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">http get https://webmention.io/api/mentions.jf2 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="nv">domain</span><span class="o">==</span>randomgeekery.org <span class="nv">token</span><span class="o">==</span><span class="nv">$WEBMENTION_KEY</span> <span class="nv">since</span><span class="o">==</span><span class="s2">&#34;2020-10-26T04:07:20Z&#34;</span> per-page<span class="o">=</span><span class="m">100</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="p">|</span> jq <span class="s1">&#39;.children | length&#39;</span></span></span></code></pre>
</figure><figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-text" data-lang="text"><span class="line"><span class="cl">0</span></span></code></pre>
</figure><p>The <code>page</code> parameter — which starts at zero — lets me step through the feed in batches.</p>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">http get https://webmention.io/api/mentions.jf2 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="nv">domain</span><span class="o">==</span>randomgeekery.org <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="nv">token</span><span class="o">==</span><span class="nv">$WEBMENTION_KEY</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  sort-dir<span class="o">==</span>up <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="nv">page</span><span class="o">==</span><span class="m">1</span></span></span></code></pre>
</figure><figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;children&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;author&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;brian wisti&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;photo&#34;</span><span class="p">:</span> <span class="s2">&#34;https://webmention.io/avatar/…&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;card&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;url&#34;</span><span class="p">:</span> <span class="s2">&#34;https://twitter.com/brianwisti&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;content&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;html&#34;</span><span class="p">:</span> <span class="s2">&#34;…&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;text&#34;</span><span class="p">:</span> <span class="s2">&#34;…&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;in-reply-to&#34;</span><span class="p">:</span> <span class="s2">&#34;https://randomgeekery.org/2020/01/19/restructuredtext-basics-for-blogging/&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;published&#34;</span><span class="p">:</span> <span class="s2">&#34;2020-03-10T06:24:45+00:00&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;entry&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;url&#34;</span><span class="p">:</span> <span class="s2">&#34;https://twitter.com/brianwisti/status/1237263101482823681&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;wm-id&#34;</span><span class="p">:</span> <span class="mi">766993</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;wm-private&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;wm-property&#34;</span><span class="p">:</span> <span class="s2">&#34;in-reply-to&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;wm-received&#34;</span><span class="p">:</span> <span class="s2">&#34;2020-03-10T06:38:55Z&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;wm-source&#34;</span><span class="p">:</span> <span class="s2">&#34;https://brid-gy.appspot.com/comment/twitter/brianwisti/…&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;wm-target&#34;</span><span class="p">:</span> <span class="s2">&#34;https://randomgeekery.org/2020/01/19/restructuredtext-basics-for-blogging/&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="err">⋮</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Webmentions&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;feed&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre>
</figure><p>Right.  That’s Bridgy catching a Twitter thread.  At least I can see the full conversation from my site.  Or I will once I’m done fixing everything.</p>
<h3 id="bonus-checking-for-reactions-to-a-specific-post">Bonus: checking for reactions to a specific post</h3>
<p>I could get a JF2 feed for specific URLs on my site if I was so inclined.</p>
<figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">http get https://webmention.io/api/mentions.jf2 <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  <span class="nv">target</span><span class="o">==</span>https://randomgeekery.org</span></span></code></pre>
</figure><figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;children&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;author&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;photo&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;card&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;url&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;mention-of&#34;</span><span class="p">:</span> <span class="s2">&#34;https://randomgeekery.org&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;published&#34;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;entry&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;url&#34;</span><span class="p">:</span> <span class="s2">&#34;https://kevq.uk/blogroll/&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;wm-id&#34;</span><span class="p">:</span> <span class="mi">796241</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;wm-private&#34;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;wm-property&#34;</span><span class="p">:</span> <span class="s2">&#34;mention-of&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;wm-received&#34;</span><span class="p">:</span> <span class="s2">&#34;2020-05-14T11:25:47Z&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;wm-source&#34;</span><span class="p">:</span> <span class="s2">&#34;https://kevq.uk/blogroll/&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;wm-target&#34;</span><span class="p">:</span> <span class="s2">&#34;https://randomgeekery.org&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;Webmentions&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;feed&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre>
</figure><p>I deal with my site reactions in bulk so they can be incorporated in the Hugo build.  This could be handy for JavaScript-driven update on reactions since the site was last built and pushed, though.</p>
<h2 id="rebuilding-the-local-mentions-file">Rebuilding the local mentions file</h2>
<p>Now I want to take what I learned about the API to build a local copy of my site’s mention history.  Let’s step away from HTTPie and the command line before I try something dangerous.</p>
<p>The <a href="https://requests.readthedocs.io/">Requests</a> library for <a href="/card/python/">card/Python</a> can help me build one list of Webmentions.</p>
<figure class="highlight">
  <figcaption><tt>rebuild-mentions-feed.py</tt></figcaption>
  <pre tabindex="0" class="chroma"
    ><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">rebuild_full_feed</span><span class="p">(</span><span class="n">domain</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">endpoint</span> <span class="o">=</span> <span class="s2">&#34;https://webmention.io/api/mentions.jf2&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">page_size</span> <span class="o">=</span> <span class="mi">100</span>
</span></span><span class="line"><span class="cl">    <span class="n">all_entries</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">page_index</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;domain&#34;</span><span class="p">:</span> <span class="n">domain</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;token&#34;</span><span class="p">:</span> <span class="n">token</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;page&#34;</span><span class="p">:</span> <span class="n">page_index</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;per-page&#34;</span><span class="p">:</span> <span class="n">page_size</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;sort-dir&#34;</span><span class="p">:</span> <span class="s2">&#34;up&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">this_page</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">entries</span> <span class="o">=</span> <span class="n">this_page</span><span class="p">[</span><span class="s2">&#34;children&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">all_entries</span> <span class="o">+=</span> <span class="n">entries</span>
</span></span><span class="line"><span class="cl">        <span class="n">page_index</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">entry_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Added </span><span class="si">{</span><span class="n">entry_count</span><span class="si">}</span><span class="s2"> entries&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Be a polite Internet citizen</span>
</span></span><span class="line"><span class="cl">        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Stop when we&#39;re done</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">entry_count</span> <span class="o">&lt;</span> <span class="n">page_size</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Reached end of feed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">target_file</span><span class="p">,</span> <span class="s2">&#34;w&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">all_entries</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Wrote </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">all_entries</span><span class="p">)</span><span class="si">}</span><span class="s2"> entries to </span><span class="si">{</span><span class="n">target_file</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">domain</span> <span class="o">=</span> <span class="s2">&#34;randomgeekery.org&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">token</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&#34;WEBMENTION_KEY&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">target_file</span> <span class="o">=</span> <span class="s2">&#34;mentions.jf2&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">rebuild_full_feed</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">target_file</span><span class="p">)</span></span></span></code></pre>
</figure><figure class="highlight">
  <pre tabindex="0" class="chroma"
    ><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> python rebuild-mentions-feed.py
</span></span><span class="line"><span class="cl"><span class="go">Added 100 entries
</span></span></span><span class="line"><span class="cl"><span class="go">Added 100 entries
</span></span></span><span class="line"><span class="cl"><span class="go">Added 100 entries
</span></span></span><span class="line"><span class="cl"><span class="go">Added 83 entries
</span></span></span><span class="line"><span class="cl"><span class="go">Reached end of feed
</span></span></span><span class="line"><span class="cl"><span class="go">Wrote 383 entries to mentions.jf2
</span></span></span></code></pre>
</figure><p>This gives me the first requirement for rebuilding my mentions: an intact historical record, up to the current moment.</p>
<h2 id="intermission">Intermission</h2>
<p>Time to pause.</p>
<p>Why?  Why not just use this JSON as a <a href="https://gohugo.io/templates/data-templates/">Hugo data file</a> — let it filter through finding relevant mentions for each post?</p>
<p>Short answer: that’s how I got myself into this mess in the first place. I want to take a more careful approach this time.</p>
<p>I have some ideas.  Spoiler alert: <a href="https://sqlite-utils.readthedocs.io/">sqlite-utils</a> is involved. <a href="/post/2020/05/querying-hugo-content-with-python/">Again</a>.</p>
<p>But first push this and get ready for bed so I’m at least a little rested for work.</p>
]]></content:encoded>
</item>
</channel>
</rss>

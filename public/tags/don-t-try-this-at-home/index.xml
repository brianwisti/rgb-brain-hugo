<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0"
  xmlns:atom="http://www.w3.org/2005/Atom"
  xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>don-t-try-this-at-homeonRandom Geekery</title>
    <link>https://randomgeekery.org/tags/don-t-try-this-at-home/</link>
    <description>
      Recent contentindon-t-try-this-at-home on Random Geekery
    </description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
      
      <lastBuildDate>Mon, 18 May 2020 14:15:00 -0700</lastBuildDate><atom:link href="https://randomgeekery.org/tags/don-t-try-this-at-home/index.xml" rel="self" type="application/rss+xml" /><item>
  <title>Post: Letting Ruby build Asciidoctor files for Hugo</title>
  <link>https://randomgeekery.org/post/2020/05/letting-ruby-build-asciidoctor-files-for-hugo/</link>
  <pubDate>Mon, 18 May 2020 14:15:00 -0700</pubDate>
  
  <guid>https://randomgeekery.org/post/2020/05/letting-ruby-build-asciidoctor-files-for-hugo/</guid>
  <description>actually really proud of myself but this post needs all the disclaimers
[!WARNING] Normal people: don’t do any of this. The whole post is me compensating for making Hugo do things it’s not good at.
Stick with [Markdown][markdown] if you use [Hugo][hugo]. Use shortcodes or render hooks if you want to make things interesting. Experiment with card/reStructuredText or card/Asciidoctor — but anything past a few pages slows builds dramatically. Move away from Hugo if you prefer those formats.</description>
   <category>post</category> 
   <category>post</category> 
   <category>ruby</category>  <category>hugo</category>  <category>asciidoctor</category>  <category>site</category>  <category>don-t-try-this-at-home</category>  <category>fine-go-ahead</category>  <category>but-i-warned-you</category>  <category>programming</category> 
  <content:encoded><![CDATA[<h2>Stuff like this is why i don't advertise my site repo</h2><p><img src="/post/2020/05/../../../attachments/img/2020/cover-2020-05-18.jpg" alt="attachments/img/2020/cover-2020-05-18.jpg"/>
actually really proud of myself but this post needs all the disclaimers</p>
<blockquote>
<p>[!WARNING]
Normal people: don&rsquo;t do any of this.  The whole post is me compensating for making Hugo do things it&rsquo;s not good at.</p>
<p>Stick with [Markdown][markdown] if you use [Hugo][hugo].  Use <a href="https://gohugo.io/content-management/shortcodes/">shortcodes</a> or <a href="https://gohugo.io/getting-started/configuration-markup#markdown-render-hooks">render hooks</a> if you want to make things interesting. Experiment with <a href="/card/restructuredtext/">card/reStructuredText</a> or <a href="/card/asciidoctor/">card/Asciidoctor</a> — but anything past a few pages slows builds dramatically.  Move <em>away</em> from Hugo if you prefer those formats.  Try [Nikola][nikola] for <code>rst</code> blogs.  [Gatsby][gatsby] has a <a href="https://www.gatsbyjs.org/packages/gatsby-transformer-asciidoc/?=asciidoctor">plugin</a> to directly transform <code>adoc</code> content.  You have options!</p>
</blockquote>
<h2 id="asciidoctor">Asciidoctor?</h2>
<p>Asciidoctor is yet another lightweight formatting language, with official implementations in Ruby, JavaScript, and Java.  Processing tools transform it into HTML, PDF, and other formats.  Like Markdown, I find it easy to read and write the format.  Like reStructuredText and [Org][org], it provides structures suited for technical and long form writing.  Oh, and clearly labeled hooks for extending if the built-in structures don’t quite meet your needs.</p>
<h2 id="whats-this-got-to-do-with-hugo">What’s this got to do with Hugo?</h2>
<p>Hugo shines with Markdown, but you can use other <a href="https://gohugo.io/content-management/formats/">content formats</a> as well.  It supports Org files directly through <a href="https://github.com/niklasfasching/go-org">go-org</a>.  reStructuredText is supported if you have <code>rst2html.py</code> installed. Asciidoc and Asciidoctor are supported if you have their processors installed. And like [Jekyll][jekyll], Hugo supports HTML as an HTML authoring language if you tack some front matter onto it.</p>
<p>I enjoy the flexibility.  And that bit about supporting HTML as an authoring language is about to come in real handy.</p>
<blockquote>
<p>[!TIP]
go-org is nice, but <a href="https://ox-hugo.scripter.co/"><code>ox-hugo</code></a> excels if you want Hugo support tightly integrated with Org mode.</p>
</blockquote>
<h2 id="so-whats-the-problem">So what’s the problem?</h2>
<p>What’s up with this?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ hugo
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                   |  EN
</span></span><span class="line"><span class="cl">-------------------+-------
</span></span><span class="line"><span class="cl">  Pages            | 1353
</span></span><span class="line"><span class="cl">  Paginator pages  |  128
</span></span><span class="line"><span class="cl">  Non-page files   |  442
</span></span><span class="line"><span class="cl">  Static files     |   31
</span></span><span class="line"><span class="cl">  Processed images | 1195
</span></span><span class="line"><span class="cl">  Aliases          | 1261
</span></span><span class="line"><span class="cl">  Sitemaps         |    1
</span></span><span class="line"><span class="cl">  Cleaned          |    0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Total in 15929 ms
</span></span></code></pre></div><p>Sixteen seconds might look impressive compared to Jekyll.  It’s more alarming if you know Hugo’s reputation for speed.</p>
<p>I think my Asciidoctor files might be causing this slowdown.  I do have quite a few of them.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> make formats
</span></span><span class="line"><span class="cl"><span class="go">hugo list all | raku -e &#39;bag(lines[1..*].map({ .split(&#34;,&#34;)[0].IO.extension })).say&#39;
</span></span></span><span class="line"><span class="cl"><span class="go">Bag(adoc(206), html, md(424))
</span></span></span></code></pre></div><p>How to confirm this?  Well, I could run <code>hugo</code> in debug mode and scan the output.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> hugo --debug &gt; debug.log
</span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="go">Building sites … INFO 2020/05/14 21:44:50 syncing static files to /home/random/Sites/rgb-hugo/randomgeekery.org/
</span></span></span><span class="line"><span class="cl"><span class="go">⋮
</span></span></span><span class="line"><span class="cl"><span class="go">INFO 2020/05/14 21:44:50 Rendering contact.adoc with /home/random/Sites/rgb-hugo/scripts/asciidoctor ...
</span></span></span><span class="line"><span class="cl"><span class="go">⋮
</span></span></span><span class="line"><span class="cl"><span class="go">INFO 2020/05/14 21:45:07 Rendering post/2020/05/querying-hugo-content-with-python/index.adoc with /home/random/Sites/rgb-hugo/scripts/asciidoctor ...
</span></span></span><span class="line"><span class="cl"><span class="go">⋮
</span></span></span><span class="line"><span class="cl"><span class="go">Total in 17235 ms
</span></span></span></code></pre></div><p>Interesting.  I only updated a single <code>.adoc</code> file — this one — but Hugo rebuilds <em>all</em> of them.  It also spends about 17 seconds doing so.  17,000 of the 17,235 milliseconds spent in this build go to rebuilding mostly unchanged Asciidoctor files.</p>
<p>Okay.</p>
<h2 id="fine-ill-do-it-myself">Fine I’ll do it myself</h2>
<p>I could always build the <code>adoc</code> files myself instead of making Hugo do it.</p>
<h3 id="hang-onis-that-even-worth-it">Hang on — is that even worth it?</h3>
<p>How long does it take for a single process to build HTML from all the <code>adoc</code> files in my site?  Not much point in this idea if Asciidoctor takes 17 seconds on its own.</p>
<p>All right.  Let’s try this with roughly the same arguments Hugo does with <a href="https://gohugo.io/content-management/formats/#external-helpers">external helpers</a>.</p>
<div class="highlight" title="build-adoc"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="nb">require</span> <span class="s2">&#34;fileutils&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">require</span> <span class="s2">&#34;asciidoctor&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="no">SRC_DIR</span> <span class="o">=</span> <span class="s2">&#34;content&#34;</span>
</span></span><span class="line"><span class="cl"><span class="no">BUILD_DIR</span> <span class="o">=</span> <span class="s2">&#34;adoc-out&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exist?</span> <span class="no">BUILD_DIR</span>
</span></span><span class="line"><span class="cl">  <span class="no">FileUtils</span><span class="o">.</span><span class="n">rm_r</span> <span class="no">BUILD_DIR</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="no">Dir</span><span class="o">[</span><span class="s2">&#34;</span><span class="si">#{</span><span class="no">SRC_DIR</span><span class="si">}</span><span class="s2">/**/*.adoc&#34;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">filename</span><span class="o">|</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># Mirror the nested folder structure where I found the `adoc` file</span>
</span></span><span class="line"><span class="cl">  <span class="n">dirname</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">branch</span> <span class="o">=</span> <span class="n">dirname</span><span class="o">.</span><span class="n">sub</span> <span class="sr">%r[^</span><span class="si">#{</span><span class="no">SRC_DIR</span><span class="si">}</span><span class="sr">/?]</span><span class="p">,</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">target_dir</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">#{</span><span class="no">BUILD_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">branch</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">target_base</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">sub</span> <span class="sr">%r{adoc$}</span><span class="p">,</span> <span class="s2">&#34;html&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="n">target_file</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">#{</span><span class="n">target_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">target_base</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="no">Asciidoctor</span><span class="o">.</span><span class="n">convert_file</span> <span class="n">filename</span><span class="p">,</span> <span class="ss">to_file</span><span class="p">:</span> <span class="n">target_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="ss">header_footer</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">safe</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">mkdirs</span><span class="p">:</span> <span class="kp">true</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><p>This fills a temporary folder with Asciidoctor’s generated HTML, keeping it out of Hugo’s way.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="line"><span class="cl"><span class="gp">$</span> <span class="nb">time</span> ruby scripts/build-adoc
</span></span><span class="line"><span class="cl"><span class="go">0.61user 0.03system 0:00.65elapsed 98%CPU (0avgtext+0avgdata 20584maxresident)k
</span></span></span><span class="line"><span class="cl"><span class="go">0inputs+3680outputs (0major+7188minor)pagefaults 0swaps
</span></span></span></code></pre></div><p>0.65 seconds to build all the <code>.adoc</code> files.</p>
<p>So yes.  Building them fresh myself is quicker than 17 seconds.  That’s about what I figured, since Hugo apparently starts a fresh Ruby process for each <code>adoc</code> file.  I used a single process for all of them.</p>
<p>This experiment is worth pursuing further.</p>
<h2 id="give-it-a-shot">Give it a shot</h2>
<p>It will be fiddly, though.  I’m going to end up adding a build step, and complicating Hugo’s normally straightforward site generation process.</p>
<h3 id="keep-the-front-matter">Keep the front matter</h3>
<p>Asciidoctor has its own <a href="https://asciidoctor.org/docs/asciidoc-syntax-quick-reference/#document-header">document header</a> rules, but I don’t have to think too much about that.  To better support <a href="https://asciidoctor.org/docs/user-manual/#static-website-generators">static site generators</a>, Asciidoctor can be told what to do with YAML front matter.  I want front matter glued back to output before saving to Hugo’s <code>content</code> folder.</p>
<p>You can <a href="https://asciidoctor.org/docs/user-manual/#extensions">extend</a> Asciidoctor at multiple points in the conversion pipeline, with code blocks or full classes.  I’ll register a block extension for the postprocessor stage: after the document has been converted, but before it gets saved.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="c1"># ...</span>
</span></span><span class="line"><span class="cl"><span class="nb">require</span> <span class="s2">&#34;asciidoctor&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">require</span> <span class="s2">&#34;asciidoctor/extensions&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="no">Asciidoctor</span><span class="o">::</span><span class="no">Extensions</span><span class="o">.</span><span class="n">register</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># reinsert &#34;front-matter&#34; attribute</span>
</span></span><span class="line"><span class="cl">  <span class="n">postprocessor</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Create a YAML front matter + HTML content document that Hugo can work with</span>
</span></span><span class="line"><span class="cl">    <span class="n">process</span> <span class="k">do</span> <span class="o">|</span><span class="n">document</span><span class="p">,</span> <span class="n">output</span><span class="o">|</span>
</span></span><span class="line"><span class="cl">      <span class="n">front_matter</span> <span class="o">=</span> <span class="n">document</span><span class="o">.</span><span class="n">attr</span> <span class="s2">&#34;front-matter&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="n">output</span> <span class="o">=</span> <span class="s2">&#34;---</span><span class="se">\n</span><span class="si">#{</span><span class="n">front_matter</span><span class="si">}</span><span class="se">\n</span><span class="s2">---</span><span class="se">\n\n</span><span class="si">#{</span><span class="n">output</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="no">Dir</span><span class="o">[</span><span class="s2">&#34;</span><span class="si">#{</span><span class="no">SRC_DIR</span><span class="si">}</span><span class="s2">/**/*.adoc&#34;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">filename</span><span class="o">|</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">  <span class="no">Asciidoctor</span><span class="o">.</span><span class="n">convert_file</span> <span class="n">filename</span><span class="p">,</span> <span class="ss">to_file</span><span class="p">:</span> <span class="n">target</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="ss">header_footer</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">safe</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">mkdirs</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># extract front matter into a `front-matter` document attribute.</span>
</span></span><span class="line"><span class="cl">    <span class="ss">attributes</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;skip-front-matter&#34;</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><h3 id="what-about-page-resources">What about page resources?</h3>
<p>For adoc files, I’ll treat the Asciidoctor content folder as the source of truth.  Cover images and other <a href="https://gohugo.io/content-management/page-bundles/">page bundle</a> files go with the <code>adoc</code>.  <code>build-adoc</code> will copy them over when converting files.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="c1"># ...</span>
</span></span><span class="line"><span class="cl"><span class="no">Dir</span><span class="o">[</span><span class="s2">&#34;</span><span class="si">#{</span><span class="no">SRC_DIR</span><span class="si">}</span><span class="s2">/**/*.adoc&#34;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">filename</span><span class="o">|</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">  <span class="no">Dir</span><span class="o">[</span><span class="s2">&#34;</span><span class="si">#{</span><span class="n">dirname</span><span class="si">}</span><span class="s2">/*&#34;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">supplemental</span><span class="o">|</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># We&#39;re just looking for resource bundle files</span>
</span></span><span class="line"><span class="cl">    <span class="k">next</span> <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">directory?</span> <span class="n">supplemental</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># We already grabbed the adoc file(s)</span>
</span></span><span class="line"><span class="cl">    <span class="k">next</span> <span class="k">if</span> <span class="n">supplemental</span> <span class="o">=~</span> <span class="sr">%r{adoc$}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="no">FileUtils</span><span class="o">.</span><span class="n">cp</span> <span class="n">supplemental</span><span class="p">,</span> <span class="n">target_dir</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><h3 id="only-rebuild-new-stuff">Only rebuild new stuff</h3>
<p>I might save a little more time — and disk writes — by limiting my build to updated adoc and supplemental files.</p>
<p>Course, it helps to stop deleting <code>BUILD_DIR</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="c1"># ...</span>
</span></span><span class="line"><span class="cl"><span class="no">Dir</span><span class="o">[</span><span class="s2">&#34;</span><span class="si">#{</span><span class="n">dirname</span><span class="si">}</span><span class="s2">/*&#34;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">supplemental</span><span class="o">|</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># We&#39;re just looking for resource bundle files</span>
</span></span><span class="line"><span class="cl">  <span class="k">next</span> <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">directory?</span> <span class="n">supplemental</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># We already grabbed the adoc file(s)</span>
</span></span><span class="line"><span class="cl">  <span class="k">next</span> <span class="k">if</span> <span class="n">supplemental</span> <span class="o">=~</span> <span class="sr">%r{adoc$}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">supplemental_base</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">basename</span> <span class="n">supplemental</span>
</span></span><span class="line"><span class="cl">  <span class="n">target_file</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">#{</span><span class="n">target_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">supplemental_base</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">copy_needed</span> <span class="o">=</span> <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exist?</span> <span class="n">target_file</span>
</span></span><span class="line"><span class="cl">                  <span class="no">File</span><span class="o">.</span><span class="n">mtime</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="o">&gt;</span> <span class="no">File</span><span class="o">.</span><span class="n">mtime</span><span class="p">(</span><span class="n">target_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span>
</span></span><span class="line"><span class="cl">                  <span class="kp">true</span>
</span></span><span class="line"><span class="cl">                <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="n">copy_needed</span>
</span></span><span class="line"><span class="cl">    <span class="nb">puts</span> <span class="s2">&#34;Converting </span><span class="si">#{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="no">FileUtils</span><span class="o">.</span><span class="n">copy</span> <span class="n">supplemental</span><span class="p">,</span> <span class="n">target_file</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span></code></pre></div><p>If processing a single file was more expensive, I’d use something more careful than a timestamp check.</p>
<h3 id="make-it-official">Make it official</h3>
<p>Let’s skip the gory details, but I eventually moved all the <code>adoc</code> posts, notes, and drafts to their own folder.  Now <code>build-adoc</code> officially generates HTML content with YAML front matter for Hugo.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="no">SRC_DIR</span> <span class="o">=</span> <span class="s2">&#34;adoc&#34;</span>
</span></span><span class="line"><span class="cl"><span class="no">BUILD_DIR</span> <span class="o">=</span> <span class="s2">&#34;content&#34;</span>
</span></span></code></pre></div><p>Since Asciidoctor finishes so promptly, I’ll run it every time I build the site.</p>
<div class="highlight" title="Makefile"><pre tabindex="0" class="chroma"><code class="language-Makefile" data-lang="Makefile"><span class="line"><span class="cl"><span class="nf">.PHONY</span><span class="o">:</span> <span class="n">adoc</span> <span class="n">build</span>
</span></span><span class="line"><span class="cl"><span class="nf">adoc</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    ruby scripts/build-adoc
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">build</span><span class="o">:</span> <span class="n">adoc</span> <span class="c">## Build live version of site
</span></span></span><span class="line"><span class="cl"><span class="c"></span>    <span class="nv">INCLUDE_ANALYTICS</span><span class="o">=</span><span class="m">1</span> hugo
</span></span><span class="line"><span class="cl">    cp etc/robots.txt randomgeekery.org/
</span></span><span class="line"><span class="cl">    cp etc/htaccess randomgeekery.org
</span></span></code></pre></div><h3 id="what-do-we-have-now">What do we have now?</h3>
<p>I finished my basic Asciidoctor + Hugo flow. How long does it take to build the site now? Let’s find out.</p>
<p>Every <code>adoc</code> file gets processed in the first run.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ time make build
</span></span><span class="line"><span class="cl"># every adoc file is converted
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">done
</span></span><span class="line"><span class="cl">INCLUDE_ANALYTICS=1 hugo
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                   |  EN
</span></span><span class="line"><span class="cl">-------------------+-------
</span></span><span class="line"><span class="cl">  Pages            | 1353
</span></span><span class="line"><span class="cl">  Paginator pages  |  128
</span></span><span class="line"><span class="cl">  Non-page files   |  431
</span></span><span class="line"><span class="cl">  Static files     |   31
</span></span><span class="line"><span class="cl">  Processed images | 1188
</span></span><span class="line"><span class="cl">  Aliases          | 1261
</span></span><span class="line"><span class="cl">  Sitemaps         |    1
</span></span><span class="line"><span class="cl">  Cleaned          |    0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Total in 1416 ms
</span></span><span class="line"><span class="cl">cp etc/robots.txt randomgeekery.org/
</span></span><span class="line"><span class="cl">cp etc/htaccess randomgeekery.org
</span></span><span class="line"><span class="cl">3.80user 0.78system 0:02.87elapsed 159%CPU (0avgtext+0avgdata 198236maxresident)k
</span></span><span class="line"><span class="cl">24inputs+505056outputs (0major+19157minor)pagefaults 0swaps
</span></span></code></pre></div><p>Less than three seconds. I like that time more than 15-18 seconds.</p>
<p>I went to a bit of trouble to only process updated <code>adoc</code> files. Does it help?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ time make build
</span></span><span class="line"><span class="cl">ruby scripts/build-adoc
</span></span><span class="line"><span class="cl">Converting adoc/draft/letting-ruby-build-asciidoctor-files-for-hugo/index.adoc
</span></span><span class="line"><span class="cl">done
</span></span><span class="line"><span class="cl">INCLUDE_ANALYTICS=1 hugo
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                   |  EN
</span></span><span class="line"><span class="cl">-------------------+-------
</span></span><span class="line"><span class="cl">  Pages            | 1354
</span></span><span class="line"><span class="cl">  Paginator pages  |  128
</span></span><span class="line"><span class="cl">  Non-page files   |  432
</span></span><span class="line"><span class="cl">  Static files     |   31
</span></span><span class="line"><span class="cl">  Processed images | 1189
</span></span><span class="line"><span class="cl">  Aliases          | 1271
</span></span><span class="line"><span class="cl">  Sitemaps         |    1
</span></span><span class="line"><span class="cl">  Cleaned          |    0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Total in 1458 ms
</span></span><span class="line"><span class="cl">cp etc/robots.txt randomgeekery.org/
</span></span><span class="line"><span class="cl">cp etc/htaccess randomgeekery.org
</span></span><span class="line"><span class="cl">3.11user 0.72system 0:01.90elapsed 200%CPU (0avgtext+0avgdata 212324maxresident)k
</span></span><span class="line"><span class="cl">64inputs+500976outputs (0major+61675minor)pagefaults 0swaps
</span></span></code></pre></div><p>Less than two seconds.  Then again, load from other system processes can add a second — or more, if I opened a browser tab to some JavaScript-intensive URL.</p>
<p>But it appears to help somewhat.  And again, I get happy when there are fewer disk writes.</p>
<h2 id="highlighting-code-samples">Highlighting code samples</h2>
<p>So at first, Asciidoctor wasn’t highlighting code samples. I had <code>:source-highlighter: rouge</code> in my document header, but it was being ignored. Rather than add preprocessor logic to ensure that the document header gets processed, I specified the same attributes for <em>every</em> file converted:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="c1"># ...</span>
</span></span><span class="line"><span class="cl"><span class="no">Asciidoctor</span><span class="o">.</span><span class="n">convert_file</span> <span class="n">filename</span><span class="p">,</span> <span class="ss">to_file</span><span class="p">:</span> <span class="n">target_file</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="ss">header_footer</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span> <span class="ss">safe</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">mkdirs</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="ss">attributes</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;icons&#34;</span> <span class="o">=&gt;</span> <span class="s2">&#34;font&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;source-highlighter&#34;</span> <span class="o">=&gt;</span> <span class="s2">&#34;rouge&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;skip-front-matter&#34;</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><p>All good now, right?</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">Rebuild failed:
</span></span><span class="line"><span class="cl">&#34;/home/random/Sites/rgb-hugo/content/post/2015/07/making-a-jekyll-collection/index.html:223:53&#34;: got closing shortcode, but none is open
</span></span></code></pre></div><p>Uh oh.</p>
<p>That’s not good.</p>
<p>When Hugo sees <code>{{ … }}</code> in my new HTML content files, it thinks that’s a shortcode!  That’s great if I <em>want</em> to invoke a shortcode.  Not so great in a <a href="/post/2015/07/making-a-jekyll-collection/">post with code samples</a> for working with templates.  Those aren’t supposed to get processed.</p>
<p>No problem.  <a href="http://rouge.jneen.net/">Rouge</a> handles syntax highlighting for my <code>adoc</code> files.  I need to take tokens that have already been transformed and make sure paired double curly braces are replaced with appropriate <a href="https://dev.w3.org/html5/html-author/charref">HTML entities</a>.  All I need is a slight  adjustment to <code>Rouge::Formatters::HTML#safe_span</code>.</p>
<p>I’d prefer to subclass <code>Rouge::Formatter::HTML</code>, but Asciidoctor chooses and creates formatters right in the middle of a <a href="https://github.com/asciidoctor/asciidoctor/blob/master/lib/asciidoctor/syntax_highlighter/rouge.rb#L15">highlight</a> method.  I would also need to create a new Asciidoctor adapter for syntax highlighting and update all my <code>adoc</code> content to use that adapter.  Great idea for later, but I don’t have that kind of time today.</p>
<p>I’ll <a href="https://en.wikipedia.org/wiki/Monkey_patch">monkey patch</a>  Rouge::Formatters::HTML<code>directly, redefining</code>safe_span` to perform the needed transformation.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="c1"># ...</span>
</span></span><span class="line"><span class="cl"><span class="nb">require</span> <span class="s2">&#34;asciidoctor/extensions&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nb">require</span> <span class="s2">&#34;rouge&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Make Rouge output safe for Hugo</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Rouge</span><span class="o">::</span><span class="no">Formatters</span><span class="o">::</span><span class="no">HTML</span>
</span></span><span class="line"><span class="cl">  <span class="k">def</span> <span class="nf">safe_span</span><span class="p">(</span><span class="n">tok</span><span class="p">,</span> <span class="n">safe_val</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">safe_val</span> <span class="o">=</span> <span class="n">safe_val</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\{\{/</span><span class="p">,</span> <span class="s2">&#34;&amp;#123;&amp;#123;&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/\}\}/</span><span class="p">,</span> <span class="s2">&#34;&amp;#125;&amp;#125;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">tok</span> <span class="o">==</span> <span class="no">Rouge</span><span class="o">::</span><span class="no">Token</span><span class="o">::</span><span class="no">Tokens</span><span class="o">::</span><span class="no">Text</span>
</span></span><span class="line"><span class="cl">      <span class="n">safe_val</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">      <span class="n">shortname</span> <span class="o">=</span> <span class="n">tok</span><span class="o">.</span><span class="n">shortname</span> <span class="p">\</span>
</span></span><span class="line"><span class="cl">        <span class="ow">or</span> <span class="k">raise</span> <span class="s2">&#34;unknown token: </span><span class="si">#{</span><span class="n">tok</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2"> for </span><span class="si">#{</span><span class="n">safe_val</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;&lt;span class=</span><span class="se">\&#34;</span><span class="si">#{</span><span class="n">shortname</span><span class="si">}</span><span class="se">\&#34;</span><span class="s2">&gt;</span><span class="si">#{</span><span class="n">safe_val</span><span class="si">}</span><span class="s2">&lt;/span&gt;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><blockquote>
<p>[!NOTE] What about shortcodes I want to keep?
This is just general advice to make Asciidoctor and Hugo play nice with each other. You don’t need to rebuild your entire site flow to use this information.</p>
<p>Say I’ve got a shortcode for displaying images as figures.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">{{​&lt; show-figure image=&#34;cover.png&#34; description=&#34;Taskwarrior edit view&#34; &gt;}}
</span></span></code></pre></div><p>Asciidoctor transforms unsafe characters into HTML entities.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl">{{​<span class="p">&lt;</span> <span class="nt">show-figure</span> <span class="na">image</span><span class="o">=</span><span class="s">&#34;cover.png&#34;</span> <span class="na">description</span><span class="o">=</span><span class="s">&#34;Taskwarrior edit view&#34;</span> <span class="p">&gt;</span>}}
</span></span></code></pre></div><p>And it looks kind of embarrassing.</p>
<p><img src="/post/2020/05/attachments/img/2020/escaped-shortcode.png" title="my shortcode got escaped" alt="screenshot showing image shortcode instead of an image"/></p>
<p>The solution? Wrap that shortcode in a <a href="https://asciidoctor.org/docs/user-manual/#pass-macros">passthrough macro</a>.</p>
<pre tabindex="0"><code class="language-adoc" data-lang="adoc">pass:[{{​&lt; show-figure image=&#34;cover.png&#34; description=&#34;Taskwarrior edit view&#34; &gt;}}]
</code></pre><p><img src="/post/2020/05/attachments/img/2020/correct-shortcode.png" title="using a passthrough macro" alt="correct shortcode"/></p>
<p>Much better.</p>
</blockquote>
<h3 id="now-what-do-we-have"><em>Now</em> what do we have?</h3>
<p>I’m not sure. Let’s find out with a typical <code>build all</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ time make all
</span></span><span class="line"><span class="cl">ruby scripts/build-adoc
</span></span><span class="line"><span class="cl">Converting adoc/draft/letting-ruby-build-asciidoctor-files-for-hugo/index.adoc
</span></span><span class="line"><span class="cl">done
</span></span><span class="line"><span class="cl">INCLUDE_ANALYTICS=1 hugo
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                   |  EN
</span></span><span class="line"><span class="cl">-------------------+-------
</span></span><span class="line"><span class="cl">  Pages            | 1354
</span></span><span class="line"><span class="cl">  Paginator pages  |  128
</span></span><span class="line"><span class="cl">  Non-page files   |  432
</span></span><span class="line"><span class="cl">  Static files     |   31
</span></span><span class="line"><span class="cl">  Processed images | 1189
</span></span><span class="line"><span class="cl">  Aliases          | 1271
</span></span><span class="line"><span class="cl">  Sitemaps         |    1
</span></span><span class="line"><span class="cl">  Cleaned          |    0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Total in 1447 ms
</span></span><span class="line"><span class="cl">cp etc/robots.txt randomgeekery.org/
</span></span><span class="line"><span class="cl">cp etc/htaccess randomgeekery.org
</span></span><span class="line"><span class="cl">perl scripts/generate-archives
</span></span><span class="line"><span class="cl">prove -r
</span></span><span class="line"><span class="cl">./t/site/test_archive.t .... ok
</span></span><span class="line"><span class="cl">./t/site/test_links.t ......
</span></span><span class="line"><span class="cl"># [mailto:brianwisti@pobox.com] is an email link, friend
</span></span><span class="line"><span class="cl">./t/site/test_links.t ...... ok
</span></span><span class="line"><span class="cl">./t/test_db.t .............. ok
</span></span><span class="line"><span class="cl">./t/test_db_persistence.t .. ok
</span></span><span class="line"><span class="cl">./t/test_pod.t ............. ok
</span></span><span class="line"><span class="cl">All tests successful.
</span></span><span class="line"><span class="cl">Files=5, Tests=10,  7 wallclock secs ( 0.26 usr  0.05 sys +  6.65 cusr  0.29 csys =  7.25 CPU)
</span></span><span class="line"><span class="cl">Result: PASS
</span></span><span class="line"><span class="cl">make all  10.44s user 1.15s system 114% cpu 10.108 total
</span></span></code></pre></div><p>Yeah there’s a lot of stuff there I still need to write about.  Long story short: by directly using Ruby to convert Asciidoctor files into HTML for Asciidoctor, build and test <em>combined</em> take noticeably less time than build alone when Hugo had to manage the whole thing.  And it’s not that different from how <code>ox-hugo</code> manages Org content.  A similar approach would probably work for <code>rst</code> files.</p>
<p>I like it for now. Keeps me from getting bored.</p>
<p>But — and this is a big but — I couldn’t recommend this approach for normal  people with things to do. Site generation now has more moving parts, which I must test and maintain if I want to share the least little note_.</p>
<h2 id="what-now">What now?</h2>
<p>Yay, everything works!</p>
<p>What’s next?  I’m not sure.  Hugo is an ever-smaller piece of my site-building workflow.  That’s <em>somewhat</em> intentional.  Still <a href="/post/2019/12/removing-mmark-has-me-grumbly/">grumbly</a> about having to fiddle with all my Markdown files last year.  But still.</p>
<ul>
<li>Probably explore some AsciiDoctor extensions. If most of the work happens  when I write a file, I won’t care much if that file takes a second to turn into HTML. And there are so many to choose from, from <a href="https://asciidoctor.org/docs/asciidoctor-diagram">Asciidoctor Diagram</a> to the <a href="https://github.com/asciidoctor/asciidoctor-extensions-lab">Extensions Lab</a> and beyond.</li>
<li>Maybe turn my shortcodes into macros? Write some of my <em>own</em> extension classes?</li>
<li>Keep exploring site generators. I love to putter. A framework that encourages puttering might suit me better than Hugo.  <a href="/card/eleventy/">Eleventy</a>, for example.</li>
</ul>
]]></content:encoded>
</item>
</channel>
</rss>
